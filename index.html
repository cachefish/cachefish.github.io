<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cachefish.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="来世做春风，浪漫且自由">
<meta property="og:type" content="website">
<meta property="og:title" content="cachecatのBlog">
<meta property="og:url" content="https://cachefish.github.io/index.html">
<meta property="og:site_name" content="cachecatのBlog">
<meta property="og:description" content="来世做春风，浪漫且自由">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cachefish.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>cachecatのBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">cachecatのBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">localhost</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">49</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/27/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">linux cmd</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 19:30:00 / 修改时间：15:59:38" itemprop="dateCreated datePublished" datetime="2022-04-27T19:30:00+08:00">2022-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-cmd/" itemprop="url" rel="index"><span itemprop="name">linux cmd</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="运维常用监控类命令"><a href="#运维常用监控类命令" class="headerlink" title="运维常用监控类命令"></a>运维常用监控类命令</h3><h4 id="查询当前整个系统每个进程的线程数"><a href="#查询当前整个系统每个进程的线程数" class="headerlink" title="查询当前整个系统每个进程的线程数"></a>查询当前整个系统每个进程的线程数</h4><ul>
<li><p>查询java个进程下的线程数情况</p>
  <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pid in $(ps -ef | <span class="keyword">grep</span> -v <span class="keyword">grep</span>|<span class="keyword">grep</span> <span class="string">&quot;java&quot;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line">);<span class="keyword">do</span> echo $&#123;pid&#125; &gt; <span class="regexp">/tmp/</span>a.txt;cat <span class="regexp">/proc/</span>$&#123;pid&#125;<span class="regexp">/status|grep Threads &gt; /</span>tmp<span class="regexp">/b.txt;paste /</span>tmp<span class="regexp">/a.txt /</span>tmp/b.txt;done | <span class="keyword">sort</span> -k3 -rn</span><br></pre></td></tr></table></figure>
<ul>
<li>for pid in $(ps -ef | grep -v grep|grep “java”|awk ‘{print $2}’<br>  获取${pid}变量为Java进程的pid</li>
</ul>
</li>
<li><p>检测系统中的僵尸进程并将其kill</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -e -o <span class="built_in">stat</span>,ppid,pid,cmd | egrep <span class="string">&#x27;^[Zz]&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>-e 用于列出所有的进程</li>
<li>-o 用于设定输出格式  stat ppid pid cmd</li>
<li>&#39;^[Zz]’ :正则匹配 ^ 第一个字符的位置 [Zz]大写的Z或小写x字母(僵尸进程状态以Z或z开头)</li>
</ul>
</li>
<li><p>批量删除僵尸进程的方法</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -e -o <span class="built_in">stat</span>,ppid,pid,cmd | egrep <span class="string">&#x27;^[Zz]&#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="built_in">kill</span> -9</span><br></pre></td></tr></table></figure></li>
<li><p>查看当前占用cpu或内存最多的几个进程</p>
<ul>
<li>获取当前系统占用CPU最高的前10个进程  <figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps aux |<span class="built_in"> head</span> -<span class="number">1</span>;ps aux |<span class="built_in"> sort</span> -rn -k3 |<span class="built_in"> head</span> -<span class="number">10</span></span><br><span class="line">-r<span class="built_in"> reverse</span> </span><br><span class="line">n numberic<span class="built_in"> sort</span></span><br><span class="line">k 第几列进行排序</span><br></pre></td></tr></table></figure></li>
<li>获取当前系统占用内存最高的前10个进程  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | <span class="built_in">head</span> -1;ps aux | <span class="built_in">sort</span> -rn -k4 | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="HTTP命令行工具curl"><a href="#HTTP命令行工具curl" class="headerlink" title="HTTP命令行工具curl"></a>HTTP命令行工具curl</h3><ul>
<li>通过curl显示网站的header信息  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I https:<span class="regexp">//</span>www.ixdba.net</span><br></pre></td></tr></table></figure></li>
<li>显示网站的HTTP状态代码  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -s -o <span class="regexp">/dev/</span>null -w %&#123;http_code&#125;<span class="string">&quot;\n&quot;</span> http:<span class="regexp">//</span>www.baidu.com</span><br><span class="line"></span><br><span class="line">-s 安静模式，不输出错误、进度</span><br><span class="line">-o 指定输出结果到某文件中</span><br><span class="line">-w 输出一些定义的元数据</span><br><span class="line"><span class="string">&quot;\n&quot;</span> 换行</span><br></pre></td></tr></table></figure></li>
<li>使用curl实现URL地址重定向  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">访问https:<span class="regexp">//</span>www.ixdba.net重定向到https:<span class="regexp">//</span>www.ixdba.net</span><br><span class="line"></span><br><span class="line">curl -L -I http:<span class="regexp">//</span>www.ixdba.net</span><br></pre></td></tr></table></figure></li>
<li>抓取网页内容并保存到本地  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -O https:<span class="regexp">//</span>www.ixdba.net<span class="regexp">/archives/</span><span class="number">2017</span><span class="regexp">/06/</span><span class="number">653</span>.htm</span><br><span class="line">-o 将文件保存在命令行中指定文件名的文件中</span><br><span class="line">-O 使用URL中的默认的文件名保存文件到本地</span><br></pre></td></tr></table></figure>
<h2 id="使用动态路由追踪及网络故障排查工具mtr命令"><a href="#使用动态路由追踪及网络故障排查工具mtr命令" class="headerlink" title="使用动态路由追踪及网络故障排查工具mtr命令"></a>使用动态路由追踪及网络故障排查工具mtr命令</h2></li>
</ul>
<h3 id="cpu性能调优工具"><a href="#cpu性能调优工具" class="headerlink" title="cpu性能调优工具"></a>cpu性能调优工具</h3><h4 id="1、vmstat命令-虚拟内存统计"><a href="#1、vmstat命令-虚拟内存统计" class="headerlink" title="1、vmstat命令 虚拟内存统计"></a>1、vmstat命令 虚拟内存统计</h4><h4 id="2、uptime命令-监控系统性能"><a href="#2、uptime命令-监控系统性能" class="headerlink" title="2、uptime命令 监控系统性能"></a>2、uptime命令 监控系统性能</h4><h4 id="3、mpstat命令-cpu实时状态监控"><a href="#3、mpstat命令-cpu实时状态监控" class="headerlink" title="3、mpstat命令 cpu实时状态监控"></a>3、mpstat命令 cpu实时状态监控</h4><h3 id="内存性能调优工具"><a href="#内存性能调优工具" class="headerlink" title="内存性能调优工具"></a>内存性能调优工具</h3><h4 id="1、free命令-查看内存使用状况"><a href="#1、free命令-查看内存使用状况" class="headerlink" title="1、free命令  查看内存使用状况"></a>1、free命令  查看内存使用状况</h4><h4 id="2、smem命令-查看内存使用状况"><a href="#2、smem命令-查看内存使用状况" class="headerlink" title="2、smem命令  查看内存使用状况"></a>2、smem命令  查看内存使用状况</h4><h3 id="磁盘性能调优工具"><a href="#磁盘性能调优工具" class="headerlink" title="磁盘性能调优工具"></a>磁盘性能调优工具</h3><h4 id="iotop命令-监控磁盘io使用状况"><a href="#iotop命令-监控磁盘io使用状况" class="headerlink" title="iotop命令 监控磁盘io使用状况"></a>iotop命令 监控磁盘io使用状况</h4><h4 id="io-statstic-输入-x2F-输出统计"><a href="#io-statstic-输入-x2F-输出统计" class="headerlink" title="io statstic(输入&#x2F;输出统计)"></a>io statstic(输入&#x2F;输出统计)</h4><h3 id="网络性能调优"><a href="#网络性能调优" class="headerlink" title="网络性能调优"></a>网络性能调优</h3><h4 id="ping命令-测试网络连通"><a href="#ping命令-测试网络连通" class="headerlink" title="ping命令 测试网络连通"></a>ping命令 测试网络连通</h4><h4 id="traceroute命令-显示网络数据报传输到指定主机的路由信息，追踪数据传输路由状况。"><a href="#traceroute命令-显示网络数据报传输到指定主机的路由信息，追踪数据传输路由状况。" class="headerlink" title="traceroute命令 显示网络数据报传输到指定主机的路由信息，追踪数据传输路由状况。"></a>traceroute命令 显示网络数据报传输到指定主机的路由信息，追踪数据传输路由状况。</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">traceroute</span> -i eth0 -s <span class="number">192.168.60.251</span> -w <span class="number">10</span> www.ixdba.com <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>指定eth0网络接口发送数据包，指定本机发送数据包的ip为192.168.60.251，并设置超时时间为10s，设置数据包大小为100Bytes。</p>
<h3 id="系统性能综合调优工具"><a href="#系统性能综合调优工具" class="headerlink" title="系统性能综合调优工具"></a>系统性能综合调优工具</h3><p>top<br>htop</p>
<h5 id="找出占用CPU-内存过高的进程"><a href="#找出占用CPU-内存过高的进程" class="headerlink" title="找出占用CPU 内存过高的进程"></a>找出占用CPU 内存过高的进程</h5><p>#!&#x2F;bin&#x2F;bash<br>echo “——————-CUP占用前10排序——————————–”<br>ps -eo user,pid,pcpu,pmem,args –sort&#x3D;-pcpu  |head -n 10<br>echo “——————-内存占用前10排序——————————–”<br>ps -eo user,pid,pcpu,pmem,args –sort&#x3D;-pmem  |head -n 10</p>
<h5 id="查看系统-CPU信息"><a href="#查看系统-CPU信息" class="headerlink" title="查看系统,CPU信息"></a>查看系统,CPU信息</h5><h6 id="查看系统内核信息"><a href="#查看系统内核信息" class="headerlink" title="查看系统内核信息"></a>查看系统内核信息</h6><p>uname -a</p>
<h6 id="查看系统内核版本"><a href="#查看系统内核版本" class="headerlink" title="查看系统内核版本"></a>查看系统内核版本</h6><p>cat &#x2F;proc&#x2F;version</p>
<h6 id="查看当前用户环境变量"><a href="#查看当前用户环境变量" class="headerlink" title="查看当前用户环境变量"></a>查看当前用户环境变量</h6><p>env</p>
<p>cat &#x2F;proc&#x2F;cpuinfo</p>
<h6 id="查看有几个逻辑cpu-包括cpu型号"><a href="#查看有几个逻辑cpu-包括cpu型号" class="headerlink" title="查看有几个逻辑cpu, 包括cpu型号"></a>查看有几个逻辑cpu, 包括cpu型号</h6><p>cat &#x2F;proc&#x2F;cpuinfo | grep name | cut -f2 -d: | uniq -c</p>
<h6 id="查看有几颗cpu-每颗分别是几核"><a href="#查看有几颗cpu-每颗分别是几核" class="headerlink" title="查看有几颗cpu,每颗分别是几核"></a>查看有几颗cpu,每颗分别是几核</h6><p>cat &#x2F;proc&#x2F;cpuinfo | grep physical | uniq -c</p>
<h6 id="查看当前CPU运行在32bit还是64bit模式下-如果是运行在32bit下也不代表CPU不支持64bit"><a href="#查看当前CPU运行在32bit还是64bit模式下-如果是运行在32bit下也不代表CPU不支持64bit" class="headerlink" title="查看当前CPU运行在32bit还是64bit模式下, 如果是运行在32bit下也不代表CPU不支持64bit"></a>查看当前CPU运行在32bit还是64bit模式下, 如果是运行在32bit下也不代表CPU不支持64bit</h6><p>getconf LONG_BIT</p>
<h6 id="结果大于0-说明支持64bit计算-lm指long-mode-支持lm则是64bit"><a href="#结果大于0-说明支持64bit计算-lm指long-mode-支持lm则是64bit" class="headerlink" title="结果大于0, 说明支持64bit计算. lm指long mode, 支持lm则是64bit"></a>结果大于0, 说明支持64bit计算. lm指long mode, 支持lm则是64bit</h6><p>cat &#x2F;proc&#x2F;cpuinfo | grep flags | grep ‘ lm ‘ | wc -l</p>
<h6 id="查看进程所有打开最大fd数"><a href="#查看进程所有打开最大fd数" class="headerlink" title="查看进程所有打开最大fd数"></a>查看进程所有打开最大fd数</h6><p>ulimit -n<br>配置dns<br>vim &#x2F;etc&#x2F;resolv.conf<br>nslookup,查看域名路由表<br>nslookup google.com<br>last, 最近登录信息列表</p>
<h6 id="最近登录的5个账号"><a href="#最近登录的5个账号" class="headerlink" title="最近登录的5个账号"></a>最近登录的5个账号</h6><p>last -n 5</p>
<h6 id="设置固定ip"><a href="#设置固定ip" class="headerlink" title="设置固定ip"></a>设置固定ip</h6><p>ifconfig em1  192.168.5.177 netmask 255.255.255.0</p>
<h6 id="查看进程内加载的环境变量"><a href="#查看进程内加载的环境变量" class="headerlink" title="查看进程内加载的环境变量"></a>查看进程内加载的环境变量</h6><p>也可以去 cd &#x2F;proc 目录下, 查看进程内存中加载的东西<br>ps eww -p  XXXXX(进程号)</p>
<h6 id="查看进程树找到服务器进程"><a href="#查看进程树找到服务器进程" class="headerlink" title="查看进程树找到服务器进程"></a>查看进程树找到服务器进程</h6><p>ps auwxf</p>
<h6 id="查看进程启动路径"><a href="#查看进程启动路径" class="headerlink" title="查看进程启动路径"></a>查看进程启动路径</h6><p>cd &#x2F;proc&#x2F;xxx(进程号)<br>ls -all</p>
<h6 id="cwd对应的是启动路径"><a href="#cwd对应的是启动路径" class="headerlink" title="cwd对应的是启动路径"></a>cwd对应的是启动路径</h6><p>添加用户, 配置sudo权限</p>
<h6 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h6><p>useradd 用户名<br>passwd 用户名</p>
<h6 id="增加sudo权限"><a href="#增加sudo权限" class="headerlink" title="增加sudo权限"></a>增加sudo权限</h6><p>vim &#x2F;etc&#x2F;sudoers<br>修改文件里面的<br> root    ALL&#x3D;(ALL)       ALL<br> 用户名 ALL&#x3D;(ALL)       ALL</p>
<h6 id="强制关闭进程名包含xxx的所有进程"><a href="#强制关闭进程名包含xxx的所有进程" class="headerlink" title="强制关闭进程名包含xxx的所有进程"></a>强制关闭进程名包含xxx的所有进程</h6><p>ps aux|grep xxx | grep -v grep | awk ‘{print $2}’ | xargs kill -9</p>
<p>查看磁盘, 文件目录基本信息</p>
<h6 id="查看磁盘挂载情况"><a href="#查看磁盘挂载情况" class="headerlink" title="查看磁盘挂载情况"></a>查看磁盘挂载情况</h6><p>mount</p>
<h6 id="查看磁盘分区信息"><a href="#查看磁盘分区信息" class="headerlink" title="查看磁盘分区信息"></a>查看磁盘分区信息</h6><p>df</p>
<h6 id="查看目录及子目录大小"><a href="#查看目录及子目录大小" class="headerlink" title="查看目录及子目录大小"></a>查看目录及子目录大小</h6><p>du -H -h</p>
<h6 id="查看当前目录下各个文件-文件夹占了多少空间-不会递归"><a href="#查看当前目录下各个文件-文件夹占了多少空间-不会递归" class="headerlink" title="查看当前目录下各个文件, 文件夹占了多少空间, 不会递归"></a>查看当前目录下各个文件, 文件夹占了多少空间, 不会递归</h6><p>du -sh *<br>wc命令</p>
<h6 id="查看文件里有多少行"><a href="#查看文件里有多少行" class="headerlink" title="查看文件里有多少行"></a>查看文件里有多少行</h6><p>wc -l filename</p>
<h6 id="看文件里有多少个word"><a href="#看文件里有多少个word" class="headerlink" title="看文件里有多少个word"></a>看文件里有多少个word</h6><p>wc -w filename</p>
<h6 id="文件里最长的那一行是多少个字"><a href="#文件里最长的那一行是多少个字" class="headerlink" title="文件里最长的那一行是多少个字"></a>文件里最长的那一行是多少个字</h6><p>wc -L filename</p>
<h6 id="统计字节数"><a href="#统计字节数" class="headerlink" title="统计字节数"></a>统计字节数</h6><p>wc -c</p>
<h4 id="常用压缩-解压缩命令"><a href="#常用压缩-解压缩命令" class="headerlink" title="常用压缩, 解压缩命令"></a>常用压缩, 解压缩命令</h4><h5 id="压缩命令"><a href="#压缩命令" class="headerlink" title="压缩命令"></a>压缩命令</h5><p>tar czvf xxx.tar 压缩目录</p>
<p>zip -r xxx.zip 压缩目录</p>
<h5 id="解压缩命令"><a href="#解压缩命令" class="headerlink" title="解压缩命令"></a>解压缩命令</h5><p>tar zxvf xxx.tar</p>
<h1 id="解压到指定文件夹"><a href="#解压到指定文件夹" class="headerlink" title="解压到指定文件夹"></a>解压到指定文件夹</h1><p>tar zxvf xxx.tar -C &#x2F;xxx&#x2F;yyy&#x2F;</p>
<p>unzip xxx.zip</p>
<h5 id="变更文件所属用户-用户组"><a href="#变更文件所属用户-用户组" class="headerlink" title="变更文件所属用户, 用户组"></a>变更文件所属用户, 用户组</h5><p>chown eagleye.eagleye xxx.log<br>chown -R *  ddd&#x2F;</p>
<h5 id="在目录下找后缀是-mysql的文件"><a href="#在目录下找后缀是-mysql的文件" class="headerlink" title="在目录下找后缀是.mysql的文件"></a>在目录下找后缀是.mysql的文件</h5><p>find &#x2F;home&#x2F;eagleye -name ‘*.mysql’ -print</p>
<h5 id="会从-x2F-usr-目录开始往下找，找最近3天之内存取过的文件。"><a href="#会从-x2F-usr-目录开始往下找，找最近3天之内存取过的文件。" class="headerlink" title="会从 &#x2F;usr 目录开始往下找，找最近3天之内存取过的文件。"></a>会从 &#x2F;usr 目录开始往下找，找最近3天之内存取过的文件。</h5><p>find &#x2F;usr -atime 3 –print</p>
<h5 id="会从-x2F-usr-目录开始往下找，找最近5天之内修改过的文件。"><a href="#会从-x2F-usr-目录开始往下找，找最近5天之内修改过的文件。" class="headerlink" title="会从 &#x2F;usr 目录开始往下找，找最近5天之内修改过的文件。"></a>会从 &#x2F;usr 目录开始往下找，找最近5天之内修改过的文件。</h5><p>find &#x2F;usr -ctime 5 –print</p>
<h5 id="会从-x2F-doc-目录开始往下找，找jacky-的、文件名开头是-j的文件。"><a href="#会从-x2F-doc-目录开始往下找，找jacky-的、文件名开头是-j的文件。" class="headerlink" title="会从 &#x2F;doc 目录开始往下找，找jacky 的、文件名开头是 j的文件。"></a>会从 &#x2F;doc 目录开始往下找，找jacky 的、文件名开头是 j的文件。</h5><p>find &#x2F;doc -user jacky -name ‘j*’ –print</p>
<h5 id="会从-x2F-doc-目录开始往下找，找寻文件名是-ja-开头或者-ma开头的文件。"><a href="#会从-x2F-doc-目录开始往下找，找寻文件名是-ja-开头或者-ma开头的文件。" class="headerlink" title="会从 &#x2F;doc 目录开始往下找，找寻文件名是 ja 开头或者 ma开头的文件。"></a>会从 &#x2F;doc 目录开始往下找，找寻文件名是 ja 开头或者 ma开头的文件。</h5><p>find &#x2F;doc ( -name ‘ja*’ -o- -name ‘ma*’ ) –print</p>
<h5 id="会从-x2F-doc-目录开始往下找，找到凡是文件名结尾为-bak的文件，把它删除掉。-exec-选项是执行的意思，rm-是删除命令，-表示文件名，“-”是规定的命令结尾。"><a href="#会从-x2F-doc-目录开始往下找，找到凡是文件名结尾为-bak的文件，把它删除掉。-exec-选项是执行的意思，rm-是删除命令，-表示文件名，“-”是规定的命令结尾。" class="headerlink" title="会从 &#x2F;doc 目录开始往下找，找到凡是文件名结尾为 bak的文件，把它删除掉。-exec 选项是执行的意思，rm 是删除命令，{ } 表示文件名，“;”是规定的命令结尾。"></a>会从 &#x2F;doc 目录开始往下找，找到凡是文件名结尾为 bak的文件，把它删除掉。-exec 选项是执行的意思，rm 是删除命令，{ } 表示文件名，“;”是规定的命令结尾。</h5><p>find &#x2F;doc -name ‘*bak’ -exec rm {} ;</p>
<h4 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h4><figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出每个ip的连接数，以及总的各个状态的连接数</span></span><br><span class="line">netstat -n | awk &#x27;/^tcp/ &#123;n=split($(NF-<span class="number">1</span>),<span class="type">array</span>,<span class="string">&quot;:&quot;</span>);<span class="keyword">if</span>(n&lt;=<span class="number">2</span>)++S[<span class="type">array</span>[(<span class="number">1</span>)]];<span class="keyword">else</span>++S[<span class="type">array</span>[(<span class="number">4</span>)]];++s[$NF];++N&#125; END &#123;<span class="keyword">for</span>(a <span class="keyword">in</span> S)&#123;printf(<span class="string">&quot;%-20s %s\n&quot;</span>, a, S[a]);++I&#125;printf(<span class="string">&quot;%-20s %s\n&quot;</span>,<span class="string">&quot;TOTAL_IP&quot;</span>,I);<span class="keyword">for</span>(a <span class="keyword">in</span> s) printf(<span class="string">&quot;%-20s %s\n&quot;</span>,a, s[a]);printf(<span class="string">&quot;%-20s %s\n&quot;</span>,<span class="string">&quot;TOTAL_LINK&quot;</span>,N);&#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计所有连接状态, </span></span><br><span class="line"><span class="comment"># CLOSED：无连接是活动的或正在进行</span></span><br><span class="line"><span class="comment"># LISTEN：服务器在等待进入呼叫</span></span><br><span class="line"><span class="comment"># SYN_RECV：一个连接请求已经到达，等待确认</span></span><br><span class="line"><span class="comment"># SYN_SENT：应用已经开始，打开一个连接</span></span><br><span class="line"><span class="comment"># ESTABLISHED：正常数据传输状态</span></span><br><span class="line"><span class="comment"># FIN_WAIT1：应用说它已经完成</span></span><br><span class="line"><span class="comment"># FIN_WAIT2：另一边已同意释放</span></span><br><span class="line"><span class="comment"># ITMED_WAIT：等待所有分组死掉</span></span><br><span class="line"><span class="comment"># CLOSING：两边同时尝试关闭</span></span><br><span class="line"><span class="comment"># TIME_WAIT：主动关闭连接一端还没有等到另一端反馈期间的状态</span></span><br><span class="line"><span class="comment"># LAST_ACK：等待所有分组死掉</span></span><br><span class="line">netstat -n | awk &#x27;/^tcp/ &#123;++state[$NF]&#125; END &#123;<span class="keyword">for</span>(key <span class="keyword">in</span> state) <span class="built_in">print</span> key,<span class="string">&quot;\t&quot;</span>,state[key]&#125;&#x27;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找较多time_wait连接</span></span><br><span class="line">netstat -n|grep TIME_WAIT|awk &#x27;&#123;<span class="built_in">print</span> $<span class="number">5</span>&#125;&#x27;|sort|uniq -c|sort -rn|<span class="built_in">head</span> -n20</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/27/wireshark-linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/wireshark-linux/" class="post-title-link" itemprop="url">wireshark</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 19:30:00 / 修改时间：15:59:34" itemprop="dateCreated datePublished" datetime="2022-04-27T19:30:00+08:00">2022-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/wireshark/" itemprop="url" rel="index"><span itemprop="name">wireshark</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="linux下进行抓包"><a href="#linux下进行抓包" class="headerlink" title="linux下进行抓包"></a>linux下进行抓包</h3><h4 id="tshark"><a href="#tshark" class="headerlink" title="tshark"></a>tshark</h4><p>tshark -i ens33(网卡名) -w  test.cap</p>
<h4 id="主要参数说明"><a href="#主要参数说明" class="headerlink" title="主要参数说明"></a>主要参数说明</h4><h6 id="接口报文捕捉"><a href="#接口报文捕捉" class="headerlink" title="接口报文捕捉"></a>接口报文捕捉</h6><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-i &lt;interface&gt;           接口名或网卡编号 (默认: 第一个非环回接口)</span></span><br><span class="line"><span class="deletion">-f &lt;capture filter&gt;      使用libpcap过滤表达式进行包过滤</span></span><br><span class="line"><span class="deletion">-s &lt;snaplen&gt;             设置每个抓包的大小，默认为65535。</span></span><br><span class="line">                        （相当于tcpdump的-s，tcpdump默认抓包的大小仅为68）</span><br><span class="line"><span class="deletion">-p                       不使用混杂模式抓捕报文（即只抓取与本机有关的流量）</span></span><br><span class="line"><span class="deletion">-I                       如果支持则启用镜像模式</span></span><br><span class="line"><span class="deletion">-B &lt;buffer size&gt;         内核缓存大小 (默认2MB)</span></span><br><span class="line"><span class="deletion">-y &lt;link type&gt;           链路层类型 (默认为找到的第一个协议)</span></span><br><span class="line"><span class="deletion">--time-stamp-type &lt;type&gt; 接口时间戳类型</span></span><br><span class="line"><span class="deletion">-D                       列出所有接口并退出</span></span><br><span class="line"><span class="deletion">-L                       列出所有接口链路层类型并退出（供-y参数使用）</span></span><br><span class="line"><span class="deletion">--list-time-stamp-types  列出所有接口时间戳类型并退出（供--time-stamp参数使用）</span></span><br></pre></td></tr></table></figure>
<h6 id="捕获终止条件"><a href="#捕获终止条件" class="headerlink" title="捕获终止条件"></a>捕获终止条件</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="keyword">c</span> &lt;packet <span class="built_in">count</span>&gt;        捕获到n个包时停止 (默认不限，持续捕获)</span><br><span class="line">-<span class="keyword">a</span> &lt;autostop cond.&gt; ...  duration:NUM - 捕获进行NUM后停止</span><br><span class="line">                         filesize:NUM - 输出文件大于NUM KB后停止</span><br><span class="line">                            <span class="keyword">file</span><span class="variable">s:NUM</span> - 输出超过NUM个文件后停止</span><br></pre></td></tr></table></figure>
<h6 id="捕获输出"><a href="#捕获输出" class="headerlink" title="捕获输出"></a>捕获输出</h6><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-b &lt;ringbuffer opt.&gt; ... duration:NUM - 在NUM秒后写入下一个文件（文件名由-w参数决定）</span><br><span class="line">                         interval:NUM - <span class="built_in">create</span> <span class="built_in">time</span> intervals <span class="keyword">of</span> NUM <span class="built_in">secs</span></span><br><span class="line">                         filesize:NUM - 在文件大于NUM KB后写入下一个文件</span><br><span class="line">                            <span class="built_in">files</span>:NUM - 循环缓存: 在NUM个文件后替换早前的</span><br></pre></td></tr></table></figure>
<h6 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h6><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="function"><span class="title">r</span> &lt;infile|-&gt;</span> 设置需要读取的文件名及路径(或<span class="string">&#x27;-&#x27;</span>表示标准输入，从终端输入)</span><br></pre></td></tr></table></figure>

<h6 id="分析处理"><a href="#分析处理" class="headerlink" title="分析处理"></a>分析处理</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-<span class="number">2</span>                       执行two-pass分析</span><br><span class="line">-M &lt;packet <span class="built_in">count</span>&gt;        执行会话自动重置</span><br><span class="line">-R &lt;<span class="keyword">read</span> <span class="built_in">filter</span>&gt;         包读取过滤使用wireshark显示过滤表达式(配合-<span class="number">2</span>参数)</span><br><span class="line">-Y &lt;<span class="keyword">display</span> <span class="built_in">filter</span>&gt;      包显示过滤使用wireshark显示过滤表达式</span><br><span class="line">-n                       不进行名称解析 (def: <span class="keyword">all</span> enabled)</span><br><span class="line">-<span class="keyword">N</span> &lt;name <span class="built_in">resolve</span> flags&gt;  启用指定的地址名字解析: <span class="string">&quot;mnNtdv&quot;</span></span><br><span class="line">                         (“<span class="keyword">m</span>”代表MAC层，“n”代表网络层，“t”代表传输层，“<span class="keyword">N</span>”代表当前异步DNS查找。)</span><br><span class="line">-d <span class="symbol">&lt;layer_type&gt;</span>==<span class="symbol">&lt;selector&gt;</span>,<span class="symbol">&lt;decode_as_protocol&gt;</span> ...</span><br><span class="line">                         <span class="string">&quot;解析为&quot;</span>,详见man帮助页面。例: tcp.port==<span class="number">8888</span>,http</span><br><span class="line">                         （注意选择子和解包协议之间不能留空格）</span><br><span class="line">-H &lt;hosts <span class="keyword">file</span>&gt;          读取主机列表文件，将被写入捕获的文件(Implies -W n)</span><br><span class="line">--enable-protocol <span class="symbol">&lt;proto_name&gt;</span></span><br><span class="line">                         启用协议报文解析</span><br><span class="line">--disable-protocol <span class="symbol">&lt;proto_name&gt;</span></span><br><span class="line">                         不对指定协议报文解析</span><br><span class="line">--enable-heuristic <span class="symbol">&lt;short_name&gt;</span></span><br><span class="line">                         启用协议报文启发式解析</span><br><span class="line">--disable-heuristic <span class="symbol">&lt;short_name&gt;</span></span><br><span class="line">                         不对指定协议报文启发式解析</span><br></pre></td></tr></table></figure>
<h6 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h6><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">-w &lt;outfile|<span class="type">-&gt;           使用pcapng</span>格式将报文写入<span class="string">&quot;outfile&quot;</span>文件</span><br><span class="line">                         (或&#x27;-&#x27;表示标准输出，直接显示在终端)</span><br><span class="line">-C &lt;config profile&gt;      启动时使用指定的配置文件</span><br><span class="line">-F &lt;output file type&gt;    设置输出文件格式类型, 默认为pcapng格式</span><br><span class="line">                         <span class="string">&quot;-F&quot;</span>留空则列出所有的文件类型</span><br><span class="line">-V                       输出中增加报文层次树(包详细信息)</span><br><span class="line">-O &lt;protocols&gt;           仅显示以下协议的详细信息，逗号分割</span><br><span class="line">-P                       每写入一个文件后进行包情况汇总</span><br><span class="line">-S &lt;separator&gt;           数据包之间的行分割符</span><br><span class="line">-x                       输出中增加<span class="number">16</span>进制和ascii字符信息(报文按字节显示)</span><br><span class="line">-T pdml|<span class="type">ps</span>|<span class="type">psml</span>|<span class="type">json</span>|<span class="type">jsonraw</span>|<span class="type">ek</span>|<span class="type">tabs</span>|<span class="type">text</span>|<span class="type">fields</span>|<span class="type">?</span></span><br><span class="line"><span class="type">                         文本输出格式 (默认文本:text</span>)</span><br><span class="line">-j &lt;protocolfilter&gt;      当-T ek|<span class="type">pdml</span>|<span class="type">json</span> 设置时协议层过滤</span><br><span class="line">                         (例：<span class="string">&quot;ip ip.flags text&quot;</span>, 过滤不展开的所有字节点，除非过滤中有指定的子节点）</span><br><span class="line">-J &lt;protocolfilter&gt;      当 -T ek|<span class="type">pdml</span>|<span class="type">json</span> 选项设置时进行顶层协议过滤，</span><br><span class="line">                         (例: <span class="string">&quot;http tcp&quot;</span>, 过滤展开的所有字节点）</span><br><span class="line">-e &lt;<span class="built_in">field</span>&gt;               当 -T fields 设置时打印字段 (如tcp.port,_ws.col.<span class="keyword">Info</span>)</span><br><span class="line">                         此选项可以多个用于打印多个字段</span><br><span class="line">-E&lt;fieldsoption&gt;=&lt;value&gt; 当-Tfields选项启用时用于输出配置:</span><br><span class="line">   bom=y|<span class="type">n</span>               打印UTF<span class="number">-8</span> BOM</span><br><span class="line">   header=y|<span class="type">n</span>            选择首行是否输出字段名（类似表头）</span><br><span class="line">   separator=/t|<span class="type">/s</span>|<span class="type">&lt;char</span>&gt; 选择字段采用tab、空格、指定可打印字符为分割符</span><br><span class="line">   occurrence=f|<span class="type">l</span>|<span class="type">a</span>      打印第一个、最后一个或全部出现的数值（默认全部）</span><br><span class="line">   aggregator=,|<span class="type">/s</span>|<span class="type">&lt;char</span>&gt; 选择字段采用逗号、空格、指定可打印字符聚合字段</span><br><span class="line">   <span class="built_in">quote</span>=d|<span class="type">s</span>|<span class="type">n</span>           选择对数值采用双引号、单引号、不用引号</span><br><span class="line">-t a|<span class="type">ad</span>|<span class="type">d</span>|<span class="type">dd</span>|<span class="type">e</span>|<span class="type">r</span>|<span class="type">u</span>|<span class="type">ud</span>|<span class="type">?  输出格式化的时间戳(默认r</span>: rel. 优先)</span><br><span class="line">-u s|<span class="type">hms</span>                 输出格式化秒(默认s:秒)</span><br><span class="line">-l                       每个包之后就刷新标准输出</span><br><span class="line">-q                       向终端输出少量信息 (e.g. 当使用统计)</span><br><span class="line">-Q                       仅向stderr输出确切错误信息(比-q信息更少)</span><br><span class="line">-g                       启用组用户读取输出文件</span><br><span class="line">-W n                     如果支持，保存额外信息到文件中</span><br><span class="line">                         n = 写入网络地址解析信息</span><br><span class="line">-X &lt;key&gt;:&lt;value&gt;         扩展选项，详见man页面</span><br><span class="line">-U tap_name              PDUs专家模式, 详见man帮助页面</span><br><span class="line">-z &lt;statistics&gt;          大量统计,详见man帮助页面</span><br><span class="line">--capture-comment &lt;comment&gt;</span><br><span class="line">                         在最新创建的输出文件中增加捕获注释(仅支持pcapng格式)</span><br><span class="line">--export-objects &lt;protocol&gt;,&lt;destdir&gt; 保存指定导出协议对象到指定目录                           </span><br><span class="line">--color                  在输出的文本格式中支持类似Wireshark图形界面的色彩,终端需要支持<span class="number">24</span>位彩色</span><br><span class="line">                         同时支持pdml、psml的色彩属性（注：这两张属性非标准）                         </span><br><span class="line">--no-duplicate-keys      如果-T json设置, 合并重复键，将多个值归并在一个键下的数组中</span><br><span class="line">--elastic-mapping-filter &lt;protocols&gt; 如果指定-G elastic-mapping,设置仅mapping文件中指定的协议</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ol>
<li><p>实时打印当前http请求的url</p>
<p> tshark -s 512 -i eth0 -n -f ‘tcp dst port 80’ -R ‘http.host and http.request.uri’ -T fields -e http.host -e http.request.uri -l | tr -d ‘\t’</p>
<p> 参数含义：</p>
<pre><code> -s 512 :只抓取前512个字节数据
 -i eth0 :捕获eth0网卡
 -n :禁止网络对象名称解析
 -f &#39;tcp dst port 80&#39; :只捕捉协议为tcp,目的端口为80的数据包
 -R &#39;http.host and http.request.uri&#39; :过滤出http.host和http.request.uri
 -T fields -e http.host -e http.request.uri :打印http.host和http.request.uri
 -l ：输出到标准输出
</code></pre>
</li>
<li><p>实时打印当前mysql查询语句</p>
<p> tshark -s 512 -i eth0 -n -f ‘tcp dst port 3306’ -R ‘mysql.query’ -T fields -e mysql.query</p>
<p> 参数含义：</p>
<pre><code> -s 512 :只抓取前512个字节数据
 -i eth0 :捕获eth0网卡
 -n :禁止网络对象名称解析
 -f &#39;tcp dst port 3306&#39; :只捕捉协议为tcp,目的端口为3306的数据包
 -R &#39;mysql.query&#39; :过滤出mysql.query
 -T fields -e mysql.query :打印mysql查询语句
</code></pre>
</li>
</ol>
<h5 id="一般来说主要分析数据报丢失或者超时。"><a href="#一般来说主要分析数据报丢失或者超时。" class="headerlink" title="一般来说主要分析数据报丢失或者超时。"></a>一般来说主要分析数据报丢失或者超时。</h5><p>1、tcp超时重传<br>2、dns解析超时</p>
<p>tcpdump -i eno1 -w &#x2F;tmp&#x2F;20211009.cap</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/27/%E9%98%BB%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/%E9%98%BB%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95%E6%9F%A5%E8%AF%A2/" class="post-title-link" itemprop="url">linux tcp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 19:30:00 / 修改时间：15:59:47" itemprop="dateCreated datePublished" datetime="2022-04-27T19:30:00+08:00">2022-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-tcp/" itemprop="url" rel="index"><span itemprop="name">linux tcp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>查看系统内核版本：<br>uname -r<br>看内核版本是否大于等于4.9，否则要升级内核，或者安装bbr。</p>
</li>
<li><p>开启BBR：</p>
</li>
</ol>
<p>echo “net.core.default_qdisc&#x3D;fq” &gt;&gt; &#x2F;etc&#x2F;sysctl.conf<br>echo “net.ipv4.tcp_congestion_control&#x3D;bbr” &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</p>
<ol start="3">
<li>保存生效：</li>
</ol>
<p>sysctl -p</p>
<ol start="4">
<li>检查BBR是否启用：</li>
</ol>
<p>sysctl net.ipv4.tcp_available_congestion_control</p>
<p>返回值一般为：net.ipv4.tcp_available_congestion_control &#x3D; reno cubic bbr</p>
<p>sysctl net.ipv4.tcp_congestion_control</p>
<p>返回值一般为：net.ipv4.tcp_congestion_control &#x3D; bbr</p>
<p>lsmod | grep bbr</p>
<p>返回值有类似：</p>
<p>tcp_bbr 20480 10</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/27/%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E4%B8%8E%E8%B0%83%E6%95%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E4%B8%8E%E8%B0%83%E6%95%B4/" class="post-title-link" itemprop="url">linux tcp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 19:30:00 / 修改时间：15:59:43" itemprop="dateCreated datePublished" datetime="2022-04-27T19:30:00+08:00">2022-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-tcp/" itemprop="url" rel="index"><span itemprop="name">linux tcp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Linux内核中的TCP参数"><a href="#Linux内核中的TCP参数" class="headerlink" title="Linux内核中的TCP参数"></a>Linux内核中的TCP参数</h4><p>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;存放着TCP参数的文件,目录中的内容用来添加网络设置，在其中的许多设置，可以用来阻止对系统的攻击，或用来设置系统的路由功能。</p>
<hr>
<h6 id="x2F-proc-x2F-sys-x2F-net-x2F-ipv4-x2F-tcp-syn-retries"><a href="#x2F-proc-x2F-sys-x2F-net-x2F-ipv4-x2F-tcp-syn-retries" class="headerlink" title="&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syn_retries"></a>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_syn_retries</h6><p>客户端发起SYN连接，如果超时会进行重传，重传的次数<br>对于一个新建连接，内核要发送多少个SYN连接请求才决定放弃。不应该大于255,默认值是5，对应于180毫秒左右时间。（对于大负载而物理通信良好的网络来说，这个值偏高，可以修改为2。这个值仅仅是针对对外的连接，对进来的连接，是由tcp_retries1决定）<br>默认值 5 建议值 1</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.ipv4.<span class="attribute">tcp_syn_retries</span>=2</span><br></pre></td></tr></table></figure>
<h6 id="tcp-synack-retries"><a href="#tcp-synack-retries" class="headerlink" title="tcp_synack_retries"></a>tcp_synack_retries</h6><p>对于远端的连接请求SYN，内核会发送SYN+ACK数据包，以确认收到上一个SYN连接请求包。这是所谓的三次握手机制的第二个步骤。这里决定内核再放弃之前所发送出的SYN+ACK数目。不应该大于255，默认值是5，对应于180秒左右时间。<br>默认值 5 建议值 1</p>
<h6 id="tcp-keepalive-time"><a href="#tcp-keepalive-time" class="headerlink" title="tcp_keepalive_time"></a>tcp_keepalive_time</h6><p>TCP发送keepalive探测消息的间隔时间（秒），用于确认TCP连接是否有效。防止两边建立连接但不发送数据的攻击。</p>
<h6 id="net-ipv4-tcp-window-scaling"><a href="#net-ipv4-tcp-window-scaling" class="headerlink" title="net.ipv4.tcp_window_scaling"></a>net.ipv4.tcp_window_scaling</h6><p>启用或关闭窗口扩大因子选项</p>
<h6 id="net-ipv4-tcp-sack"><a href="#net-ipv4-tcp-sack" class="headerlink" title="net.ipv4.tcp_sack"></a>net.ipv4.tcp_sack</h6><p>启用或关闭选择确认（Selective Acknowledgement， SACK）选项</p>
<h6 id="net-ipv4-tcp-timestamps-x3D-1"><a href="#net-ipv4-tcp-timestamps-x3D-1" class="headerlink" title="net.ipv4.tcp_timestamps &#x3D; 1"></a>net.ipv4.tcp_timestamps &#x3D; 1</h6><p>说明：<br>该参数控制RFC 1323 时间戳与窗口缩放选项。默认情况下，启用时间戳与<br>窗口缩放，但是可以使用标志位进行控制。0位控制窗口缩放，1 位控制时间戳。<br>值为0（禁用 RFC 1323选项）<br>值为1（仅启用窗口缩放）<br>值为2（仅启用时间戳）<br>值为3（两个选项均启用）</p>
<h6 id="net-ipv4-tcp-timestamps-x3D-0"><a href="#net-ipv4-tcp-timestamps-x3D-0" class="headerlink" title="net.ipv4.tcp_timestamps&#x3D;0"></a>net.ipv4.tcp_timestamps&#x3D;0</h6><p>说明：时间戳可以避免序列号的卷绕。一个1Gbps的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。这里需要将其关掉。</p>
<p>值为0（禁用时间戳）<br>值为1（启用时间戳）</p>
<p>只有客户端和服务端都开启时间戳的情况下，才会出现能ping通不能建立tcp三次握手的情况，所以做为提供服务的公司，不可能保证所有的用户都关闭时间戳，这个功能，所以我们必须关闭时间戳，这样才能给所用用户提供正常的服务。</p>
<h6 id="net-ipv4-tcp-window-scaling-x3D-1"><a href="#net-ipv4-tcp-window-scaling-x3D-1" class="headerlink" title="net.ipv4.tcp_window_scaling &#x3D; 1"></a>net.ipv4.tcp_window_scaling &#x3D; 1</h6><h6 id="net-ipv4-tcp-sack-x3D-1"><a href="#net-ipv4-tcp-sack-x3D-1" class="headerlink" title="net.ipv4.tcp_sack &#x3D; 1"></a>net.ipv4.tcp_sack &#x3D; 1</h6><p>使用 Selective ACK﹐它可以用来查找特定的遗失的数据报— 因此有助于快速恢复状态。该文件表示是否启用有选择的应答（Selective Acknowledgment），这可以通过有选择地应答乱序接收到的报文来提高性能（这样可以让发送者只发送丢失的报文段）。(对于广域网通信来说这个选项应该启用，但是这会增加对 CPU 的占用。)</p>
<h6 id="net-ipv4-tcp-fack-x3D-1"><a href="#net-ipv4-tcp-fack-x3D-1" class="headerlink" title="net.ipv4.tcp_fack &#x3D; 1"></a>net.ipv4.tcp_fack &#x3D; 1</h6><p>打开FACK(Forward ACK)拥塞避免和快速重传功能。(注意，当tcp_sack设置为0的时候，这个值即使设置为1也无效)</p>
<h6 id="net-ipv4-tcp-retrans-collapse-x3D-1"><a href="#net-ipv4-tcp-retrans-collapse-x3D-1" class="headerlink" title="net.ipv4.tcp_retrans_collapse &#x3D; 1"></a>net.ipv4.tcp_retrans_collapse &#x3D; 1</h6><h6 id="net-ipv4-tcp-syn-retries-x3D-5"><a href="#net-ipv4-tcp-syn-retries-x3D-5" class="headerlink" title="net.ipv4.tcp_syn_retries &#x3D; 5"></a>net.ipv4.tcp_syn_retries &#x3D; 5</h6><p>对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，对应于180秒左右时间。(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.这个值仅仅是针对对外的连接,对进来的连接,是由tcp_retries1 决定的)</p>
<h6 id="net-ipv4-tcp-synack-retries-x3D-5"><a href="#net-ipv4-tcp-synack-retries-x3D-5" class="headerlink" title="net.ipv4.tcp_synack_retries &#x3D; 5"></a>net.ipv4.tcp_synack_retries &#x3D; 5</h6><p>tcp_synack_retries显示或设定 Linux 核心在回应 SYN 要求时会尝试多少次重新发送初始 SYN,ACK 封包后才决定放弃。这是所谓的三段交握 (threeway handshake) 的第二个步骤。即是说系统会尝试多少次去建立由远端启始的 TCP 连线。tcp_synack_retries 的值必须为正整数，并不能超过 255。因为每一次重新发送封包都会耗费约 30 至 40 秒去等待才决定尝试下一次重新发送或决定放弃。tcp_synack_retries 的缺省值为 5，即每一个连线要在约 180 秒 (3 分钟) 后才确定逾时.</p>
<h6 id="net-ipv4-tcp-max-orphans-x3D-131072"><a href="#net-ipv4-tcp-max-orphans-x3D-131072" class="headerlink" title="net.ipv4.tcp_max_orphans &#x3D; 131072"></a>net.ipv4.tcp_max_orphans &#x3D; 131072</h6><p>系统所能处理不属于任何进程的TCP sockets最大数量。假如超过这个数量，那么不属于任何进程的连接会被立即reset，并同时显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的 DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制，更应该增加这个值(如果增加了内存之后)。每个孤儿套接字最多能够吃掉你64K不可交换的内存。</p>
<h6 id="net-ipv4-tcp-max-tw-buckets-x3D-5000"><a href="#net-ipv4-tcp-max-tw-buckets-x3D-5000" class="headerlink" title="net.ipv4.tcp_max_tw_buckets &#x3D; 5000"></a>net.ipv4.tcp_max_tw_buckets &#x3D; 5000</h6><p>表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000。设为较小数值此项参数可以控制TIME_WAIT套接字的最大数量，避免服务器被大量的TIME_WAIT套接字拖死。</p>
<h6 id="net-ipv4-tcp-keepalive-time-x3D-7200"><a href="#net-ipv4-tcp-keepalive-time-x3D-7200" class="headerlink" title="net.ipv4.tcp_keepalive_time &#x3D; 7200"></a>net.ipv4.tcp_keepalive_time &#x3D; 7200</h6><h6 id="net-ipv4-tcp-keepalive-probes-x3D-9"><a href="#net-ipv4-tcp-keepalive-probes-x3D-9" class="headerlink" title="net.ipv4.tcp_keepalive_probes &#x3D; 9"></a>net.ipv4.tcp_keepalive_probes &#x3D; 9</h6><h6 id="net-ipv4-tcp-keepalive-intvl-x3D-75"><a href="#net-ipv4-tcp-keepalive-intvl-x3D-75" class="headerlink" title="net.ipv4.tcp_keepalive_intvl &#x3D; 75"></a>net.ipv4.tcp_keepalive_intvl &#x3D; 75</h6><p>用实例进行说明上述三个参数：</p>
<p>如果某个TCP连接在idle 2个小时后,内核才发起probe(探查).如果probe 9次(每次75秒既tcp_keepalive_intvl值)不成功,内核才彻底放弃,认为该连接已失效。</p>
<h6 id="net-ipv4-tcp-retries1-x3D-3"><a href="#net-ipv4-tcp-retries1-x3D-3" class="headerlink" title="net.ipv4.tcp_retries1 &#x3D; 3"></a>net.ipv4.tcp_retries1 &#x3D; 3</h6><p>放弃回应一个TCP连接请求前﹐需要进行多少次重试。RFC 规定最低的数值是3﹐这也是默认值﹐根据RTO的值大约在3秒 - 8分钟之间。(注意:这个值同时还决定进入的syn连接)</p>
<p>(第二种解释：它表示的是TCP传输失败时不检测路由表的最大的重试次数，当超过了这个值，我们就需要检测路由表了)</p>
<h6 id="net-ipv4-tcp-retries2-x3D-15"><a href="#net-ipv4-tcp-retries2-x3D-15" class="headerlink" title="net.ipv4.tcp_retries2 &#x3D; 15"></a>net.ipv4.tcp_retries2 &#x3D; 15</h6><p>在丢弃激活(已建立通讯状况)的TCP连接之前﹐需要进行多少次重试。默认值为15，根据RTO的值来决定，相当于13-30分钟(RFC1122规定，必须大于100秒).(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5)</p>
<p>(第二种解释：表示重试最大次数，只不过这个值一般要比上面的值大。和上面那个不同的是，当重试次数超过这个值，我们就必须放弃重试了)</p>
<h6 id="net-ipv4-tcp-orphan-retries"><a href="#net-ipv4-tcp-orphan-retries" class="headerlink" title="net.ipv4.tcp_orphan_retries"></a>net.ipv4.tcp_orphan_retries</h6><p>主要是针对孤立的socket(也就是已经从进程上下文中删除了，可是还有一些清理工作没有完成).对于这种socket，我们重试的最大的次数就是它</p>
<h6 id="net-ipv4-tcp-fin-timeout-x3D-30"><a href="#net-ipv4-tcp-fin-timeout-x3D-30" class="headerlink" title="net.ipv4.tcp_fin_timeout &#x3D; 30"></a>net.ipv4.tcp_fin_timeout &#x3D; 30</h6><p>表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间</p>
<h6 id="net-ipv4-tcp-tw-recycle-x3D-1"><a href="#net-ipv4-tcp-tw-recycle-x3D-1" class="headerlink" title="net.ipv4.tcp_tw_recycle &#x3D; 1"></a>net.ipv4.tcp_tw_recycle &#x3D; 1</h6><p>表示开启TCP连接中TIME-WAITsockets的快速回收，默认为0，表示关闭</p>
<h6 id="net-ipv4-tcp-stdurg-x3D-0"><a href="#net-ipv4-tcp-stdurg-x3D-0" class="headerlink" title="net.ipv4.tcp_stdurg &#x3D; 0"></a>net.ipv4.tcp_stdurg &#x3D; 0</h6><h6 id="net-ipv4-tcp-rfc1337-x3D-0"><a href="#net-ipv4-tcp-rfc1337-x3D-0" class="headerlink" title="net.ipv4.tcp_rfc1337 &#x3D; 0"></a>net.ipv4.tcp_rfc1337 &#x3D; 0</h6><h6 id="net-ipv4-tcp-max-syn-backlog-x3D-8192"><a href="#net-ipv4-tcp-max-syn-backlog-x3D-8192" class="headerlink" title="net.ipv4.tcp_max_syn_backlog &#x3D; 8192"></a>net.ipv4.tcp_max_syn_backlog &#x3D; 8192</h6><p>表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。</p>
<p>(第二种解释：端口最大backlog 内核限制。此参数限制服务端应用程序 可以设置的端口最大backlog 值 (对应于端口的 syn_backlog 和 backlog 队列长度)。动机是在内存有限的服务器上限制&#x2F;避免应用程序配置超大 backlog 值而耗尽内核内存。如果应用程序设置 backlog 大于此值，操作系统将自动将之限制到此值。)</p>
<h6 id="net-ipv4-tcp-abort-on-overflow-x3D-0"><a href="#net-ipv4-tcp-abort-on-overflow-x3D-0" class="headerlink" title="net.ipv4.tcp_abort_on_overflow &#x3D; 0"></a>net.ipv4.tcp_abort_on_overflow &#x3D; 0</h6><p>当 tcp 建立连接的 3 路握手完成后，将连接置入ESTABLISHED 状态并交付给应用程序的 backlog 队列时，会检查 backlog 队列是否已满。若已满，通常行为是将连接还原至 SYN_ACK状态，以造成 3 路握手最后的 ACK 包意外丢失假象 —— 这样在客户端等待超时后可重发 ACK —— 以再次尝试进入ESTABLISHED 状态 —— 作为一种修复&#x2F;重试机制。如果启用tcp_abort_on_overflow 则在检查到 backlog 队列已满时，直接发 RST 包给客户端终止此连接 —— 此时客户端程序会收到 104Connection reset by peer 错误。</p>
<p>警告：启用此选项可能导致高峰期用户访问体验到 104:Connection reset by peer 或白屏错误(视浏览器而定)。在考虑启用此选项前应先设法优化提高服务端应用程序的性能，使之能更快接管、处理连接。</p>
<h6 id="net-ipv4-tcp-syncookies-x3D-1"><a href="#net-ipv4-tcp-syncookies-x3D-1" class="headerlink" title="net.ipv4.tcp_syncookies &#x3D; 1"></a>net.ipv4.tcp_syncookies &#x3D; 1</h6><p> 在 tcp 建立连接的 3 路握手过程中，当服务端收到最初的 SYN 请求时，会检查应用程序的 syn_backlog 队列是否已满。若已满，通常行为是丢弃此 SYN 包。若未满，会再检查应用程序的 backlog 队列是否已满。若已满并且系统根据历史记录判断该应用程序不会较快消耗连接时，则丢弃此 SYN 包。如果启用 tcp_syncookies 则在检查到 syn_backlog 队列已满时，不丢弃该 SYN 包，而改用 syncookie 技术进行 3 路握手。</p>
<p>警告：使用 syncookie 进行握手时，因为该技术挪用了 tcp_options 字段空间，会强制关闭 tcp 高级流控技术而退化成原始 tcp 模式。此模式会导致封包 丢失时 对端 要等待 MSL 时间来发现丢包事件并重试，以及关闭连接时 TIME_WAIT 状态保持 2MSL 时间。该技术应该仅用于保护syn_flood 攻击。如果在正常服务器环境中服务器负载较重导致 syn_backlog 和 backlog 队列满时，应优化服务端应用程序的负载能力，加大应用程序 backlog 值。不过，所幸该参数是自动值，仅在 syn_backlog 队列满时才会触发 (在队列恢复可用时此行为关闭)。</p>
<p>Ø  服务端应用程序设置端口backlog 值，内核理论上将允许该端口最大同时接收 2*backlog 个并发连接”请求”(不含已被应用程序接管的连接) ——分别存放在 syn_backlog 和 backlog 队列—— 每个队列的长度为backlog 值。syn_backlog 队列存储 SYN_ACK 状态的连接，backlog 则存储 ESTABLISHED 状态但尚未被应用程序接管的连接。</p>
<p>Ø  syn_backlog 队列实际上是个 hash 表，并且 hash 表大小为 2 的次方。所以实际 syn_backlog 的队列长度要略大于应用程序设置的 backlog 值—— 取对应 2 的次方值。</p>
<p>Ø  当 backlog 值较小，而高峰期并发连接请求超高时，tcp 建立连接的三路握手 网络时延将成为瓶颈 —— 并发连接超高时，syn_backlog 队列将被充满而导致 <code>can’t connect</code> 错误。此时，再提高服务端应用程序的吞吐能力已不起作用，因为连接尚未建立，服务端应用程序并不能接管和处理这些连接—— 而是需要加大backlog 值 (syn_backlog 队列长度) 来缓解此问题。</p>
<p>Ø  启用 syncookie 虽然也可以解决超高并发时的<code>can’t connect</code> 问题，但会导致 TIME_WAIT 状态 fallback 为保持 2MSL 时间，高峰期时会导致客户端无可复用连接而无法连接服务器 (tcp 连接复用是基于 &lt;src_ip, src_port, dst_ip, dst_port&gt; 四元组值必须不相同，就访问同一个目标服务器而言，&lt;src_ip, dst_ip, dst_port&gt; 三元组值不变，所以此时可用的连接数限制为仅src_port 所允许数目，这里处于 TIME_WAIT 状态的相同 src_port 连接不可复用。Linux 系统甚至更严格，只使用了 &lt;src_ip, src_port, dst_ip&gt; 三元组…)。故不建议依赖syncookie。</p>
<h6 id="net-ipv4-tcp-orphan-retries-x3D-0"><a href="#net-ipv4-tcp-orphan-retries-x3D-0" class="headerlink" title="net.ipv4.tcp_orphan_retries &#x3D; 0"></a>net.ipv4.tcp_orphan_retries &#x3D; 0</h6><p>本端试图关闭TCP连接之前重试多少次。缺省值是7，相当于50秒~16分钟(取决于RTO)。如果你的机器是一个重载的WEB服务器，你应该考虑减低这个值，因为这样的套接字会消耗很多重要的资源。参见tcp_max_orphans</p>
<h6 id="net-ipv4-tcp-sack-x3D-1-1"><a href="#net-ipv4-tcp-sack-x3D-1-1" class="headerlink" title="net.ipv4.tcp_sack &#x3D; 1"></a>net.ipv4.tcp_sack &#x3D; 1</h6><p>  SACK(SelectiveAcknowledgment，选择性确认)技术，使TCP只重新发送交互过程中丢失的包，不用发送后续所有的包，而且提供相应机制使接收方能告诉发送方哪些数据丢失，哪些数据重发了，哪些数据已经提前收到了。如此大大提高了客户端与服务器端数据交互的效率。</p>
<h6 id="net-ipv4-tcp-reordering-x3D-3"><a href="#net-ipv4-tcp-reordering-x3D-3" class="headerlink" title="net.ipv4.tcp_reordering &#x3D; 3"></a>net.ipv4.tcp_reordering &#x3D; 3</h6><h6 id="net-ipv4-tcp-ecn-x3D-2"><a href="#net-ipv4-tcp-ecn-x3D-2" class="headerlink" title="net.ipv4.tcp_ecn &#x3D; 2"></a>net.ipv4.tcp_ecn &#x3D; 2</h6><h6 id="net-ipv4-tcp-dsack-x3D-1"><a href="#net-ipv4-tcp-dsack-x3D-1" class="headerlink" title="net.ipv4.tcp_dsack &#x3D; 1"></a>net.ipv4.tcp_dsack &#x3D; 1</h6><p>允许TCP发送”两个完全相同”的SACK。</p>
<h6 id="net-ipv4-tcp-mem-x3D-178368-237824-356736"><a href="#net-ipv4-tcp-mem-x3D-178368-237824-356736" class="headerlink" title="net.ipv4.tcp_mem &#x3D; 178368  237824     356736"></a>net.ipv4.tcp_mem &#x3D; 178368  237824     356736</h6><p>同样有3个值,意思是:<br>net.ipv4.tcp_mem[0]: 低于此值,TCP没有内存压力.<br>net.ipv4.tcp_mem[1]: 在此值下,进入内存压力阶段.<br>net.ipv4.tcp_mem[2]: 高于此值,TCP拒绝分配socket.</p>
<h6 id="net-ipv4-tcp-wmem-x3D-4096-16384-4194304"><a href="#net-ipv4-tcp-wmem-x3D-4096-16384-4194304" class="headerlink" title="net.ipv4.tcp_wmem &#x3D; 4096   16384       4194304"></a>net.ipv4.tcp_wmem &#x3D; 4096   16384       4194304</h6><p>TCP写buffer,可参考的优化值: 8192436600 873200</p>
<h6 id="net-ipv4-tcp-rmem-x3D-4096-87380-4194304"><a href="#net-ipv4-tcp-rmem-x3D-4096-87380-4194304" class="headerlink" title="net.ipv4.tcp_rmem &#x3D; 4096     87380       4194304"></a>net.ipv4.tcp_rmem &#x3D; 4096     87380       4194304</h6><p>TCP读buffer,可参考的优化值:32768  436600  873200</p>
<h6 id="net-ipv4-tcp-app-win-x3D-31"><a href="#net-ipv4-tcp-app-win-x3D-31" class="headerlink" title="net.ipv4.tcp_app_win &#x3D; 31"></a>net.ipv4.tcp_app_win &#x3D; 31</h6><h6 id="net-ipv4-tcp-adv-win-scale-x3D-2"><a href="#net-ipv4-tcp-adv-win-scale-x3D-2" class="headerlink" title="net.ipv4.tcp_adv_win_scale &#x3D; 2"></a>net.ipv4.tcp_adv_win_scale &#x3D; 2</h6><h6 id="net-ipv4-tcp-tw-reuse-x3D-1"><a href="#net-ipv4-tcp-tw-reuse-x3D-1" class="headerlink" title="net.ipv4.tcp_tw_reuse &#x3D; 1"></a>net.ipv4.tcp_tw_reuse &#x3D; 1</h6><p>表示开启重用。允许将TIME-WAITsockets重新用于新的TCP连接，默认为0，表示关闭；</p>
<h6 id="net-ipv4-tcp-frto-x3D-2"><a href="#net-ipv4-tcp-frto-x3D-2" class="headerlink" title="net.ipv4.tcp_frto &#x3D; 2"></a>net.ipv4.tcp_frto &#x3D; 2</h6><p> 开启F-RTO,一个针对TCP重传超时(RTOs)的增强的恢复算法。在无线环境下特别有益处，因为在这种环境下分组丢失典型地是因为随机无线电干扰而不是中间路由器组塞。参考RFC 4318了解更多的细节。</p>
<p>这个文件拥有下列值之一:</p>
<p>Ø  0 禁用。</p>
<p>Ø  1 开启基本版本的F-RTO算法。</p>
<p>Ø  2 如果流使用SACK的话，开启SACK-增强的F-TRO算法。不过当使用SACK时是基本版本也是可以使用的，因为有这种场景存在，F-RTO和开启SACK的TCP流分组计数合作不好。</p>
<h6 id="net-ipv4-tcp-frto-response-x3D-0"><a href="#net-ipv4-tcp-frto-response-x3D-0" class="headerlink" title="net.ipv4.tcp_frto_response &#x3D; 0"></a>net.ipv4.tcp_frto_response &#x3D; 0</h6><p> 当F-RTO侦测到TCP超时是伪的时(例如，通过设置了更长的超时值避免了超时),TCP有几个选项决定接下来如何去做。可能的值是：</p>
<p>Ø  1 基于速率减半;平滑保守的响应，导致一个RTT之后拥塞窗口(cwnd)和慢启动阀值(ssthresh)减半。</p>
<p>Ø  2非常保守的响应;不推荐这样做，因为即时有效，它和TCP的其他部分交互不好;立即减半拥塞窗口(cwnd)和慢启动阀值(ssthresh)。</p>
<p>Ø  3侵占性的响应;废弃现在已知不必要的拥塞控制措施(或略一个将引起TCP更加谨慎保守的丢失的重传);cwnd and ssthresh恢复到超时之前的值。</p>
<h6 id="net-ipv4-tcp-slow-start-after-idle-x3D-1"><a href="#net-ipv4-tcp-slow-start-after-idle-x3D-1" class="headerlink" title="net.ipv4.tcp_slow_start_after_idle &#x3D; 1"></a>net.ipv4.tcp_slow_start_after_idle &#x3D; 1</h6><p>表示拥塞窗口在经过一段空闲时间后仍然有效而不必重新初始化。</p>
<h6 id="net-ipv4-tcp-low-latency-x3D-0"><a href="#net-ipv4-tcp-low-latency-x3D-0" class="headerlink" title="net.ipv4.tcp_low_latency &#x3D; 0"></a>net.ipv4.tcp_low_latency &#x3D; 0</h6><p> 允许 TCP&#x2F;IP 协议栈适应在高吞吐量情况下低延时的情况；这个选项应该禁用。</p>
<h6 id="net-ipv4-tcp-no-metrics-save-x3D-0"><a href="#net-ipv4-tcp-no-metrics-save-x3D-0" class="headerlink" title="net.ipv4.tcp_no_metrics_save &#x3D; 0"></a>net.ipv4.tcp_no_metrics_save &#x3D; 0</h6><p>一个tcp连接关闭后,把这个连接曾经有的参数比如慢启动门限snd_sthresh,拥塞窗口snd_cwnd 还有srtt等信息保存到dst_entry中, 只要dst_entry 没有失效,下次新建立相同连接的时候就可以使用保存的参数来初始化这个连接.tcp_no_metrics_save 设置为1就是不保持这些参数(经验值),每次建立连接后都重新摸索一次. 我觉得没什么好处. 所以系统默认把它设为0。</p>
<h6 id="net-ipv4-tcp-moderate-rcvbuf-x3D-1"><a href="#net-ipv4-tcp-moderate-rcvbuf-x3D-1" class="headerlink" title="net.ipv4.tcp_moderate_rcvbuf &#x3D; 1"></a>net.ipv4.tcp_moderate_rcvbuf &#x3D; 1</h6><p>打开了TCP内存自动调整功能(1为打开、0为禁止)</p>
<h6 id="net-ipv4-tcp-tso-win-divisor-x3D-3"><a href="#net-ipv4-tcp-tso-win-divisor-x3D-3" class="headerlink" title="net.ipv4.tcp_tso_win_divisor &#x3D; 3"></a>net.ipv4.tcp_tso_win_divisor &#x3D; 3</h6><p>单个TSO段可消耗拥塞窗口的比例，默认值为3。</p>
<h6 id="net-ipv4-tcp-congestion-control-x3D-cubic"><a href="#net-ipv4-tcp-congestion-control-x3D-cubic" class="headerlink" title="net.ipv4.tcp_congestion_control &#x3D; cubic"></a>net.ipv4.tcp_congestion_control &#x3D; cubic</h6><h6 id="net-ipv4-tcp-available-congestion-control-x3D-cubic-reno"><a href="#net-ipv4-tcp-available-congestion-control-x3D-cubic-reno" class="headerlink" title="net.ipv4.tcp_available_congestion_control &#x3D; cubic reno"></a>net.ipv4.tcp_available_congestion_control &#x3D; cubic reno</h6><h6 id="net-ipv4-tcp-allowed-congestion-control-x3D-cubic-reno"><a href="#net-ipv4-tcp-allowed-congestion-control-x3D-cubic-reno" class="headerlink" title="net.ipv4.tcp_allowed_congestion_control &#x3D; cubic reno"></a>net.ipv4.tcp_allowed_congestion_control &#x3D; cubic reno</h6><p>丢包使得TCP传输速度大幅下降的主要原因是丢包重传机制，控制这一机制的就是TCP拥塞控制算法。   congestion(拥塞)</p>
<p>Linux内核中提供了若干套TCP拥塞控制算法，已加载进内核的可以通过内核参数net.ipv4.tcp_available_congestion_control看到：</p>
<p>没有加载进内核的一般是编译成了模块，可以用modprobe加载，这些算法各自适用于不同的环境。</p>
<p>Ø  reno是最基本的拥塞控制算法，也是TCP协议的实验原型。</p>
<p>Ø  bic适用于rtt较高但丢包极为罕见的情况，比如北美和欧洲之间的线路，这是2.6.8到2.6.18之间的Linux内核的默认算法。</p>
<p>Ø  cubic是修改版的bic，适用环境比bic广泛一点，它是2.6.19之后的linux内核的默认算法。</p>
<p>Ø  hybla适用于高延时、高丢包率的网络，比如卫星链路。</p>
<p>载入tcp_hybl模块 modprobe tcp_hybla</p>
<p>TCP拥塞控制算法对TCP传输速率的影响可很大。</p>
<h6 id="net-ipv4-tcp-abc-x3D-0"><a href="#net-ipv4-tcp-abc-x3D-0" class="headerlink" title="net.ipv4.tcp_abc &#x3D; 0"></a>net.ipv4.tcp_abc &#x3D; 0</h6><h6 id="net-ipv4-tcp-mtu-probing-x3D-0"><a href="#net-ipv4-tcp-mtu-probing-x3D-0" class="headerlink" title="net.ipv4.tcp_mtu_probing &#x3D; 0"></a>net.ipv4.tcp_mtu_probing &#x3D; 0</h6><h6 id="net-ipv4-tcp-fastopen"><a href="#net-ipv4-tcp-fastopen" class="headerlink" title="net.ipv4.tcp_fastopen"></a>net.ipv4.tcp_fastopen</h6><p> GoogleTFO特性，kernel 3.6以上版本支持，具体实现方法参考本文档 Google TFO特性。</p>
<h6 id="net-ipv4-tcp-base-mss-x3D-512"><a href="#net-ipv4-tcp-base-mss-x3D-512" class="headerlink" title="net.ipv4.tcp_base_mss&#x3D; 512"></a>net.ipv4.tcp_base_mss&#x3D; 512</h6><p>分组层路径MTU发现(MTU探测)中使用的search_low的初始值。如果允许MTU探测，这个初始值就是连接使用的初始MSS值。</p>
<h6 id="net-ipv4-route-min-adv-mss-x3D-256"><a href="#net-ipv4-route-min-adv-mss-x3D-256" class="headerlink" title="net.ipv4.route.min_adv_mss&#x3D; 256"></a>net.ipv4.route.min_adv_mss&#x3D; 256</h6><p>该文件表示最小的MSS（MaximumSegment Size）大小，取决于第一跳的路由器MTU。</p>
<h6 id="net-ipv4-tcp-workaround-signed-windows-x3D-0"><a href="#net-ipv4-tcp-workaround-signed-windows-x3D-0" class="headerlink" title="net.ipv4.tcp_workaround_signed_windows &#x3D; 0"></a>net.ipv4.tcp_workaround_signed_windows &#x3D; 0</h6><h6 id="net-ipv4-tcp-dma-copybreak-x3D-4096"><a href="#net-ipv4-tcp-dma-copybreak-x3D-4096" class="headerlink" title="net.ipv4.tcp_dma_copybreak&#x3D; 4096"></a>net.ipv4.tcp_dma_copybreak&#x3D; 4096</h6><pre><code>     下限.以字节为单位.socket 的大小将卸载到一个 dma 复制引擎.如果存在一个在系统和内核配置为使用 config_net_dma 选项。
</code></pre>
<h6 id="net-ipv4-tcp-max-ssthresh-x3D-0"><a href="#net-ipv4-tcp-max-ssthresh-x3D-0" class="headerlink" title="net.ipv4.tcp_max_ssthresh&#x3D; 0"></a>net.ipv4.tcp_max_ssthresh&#x3D; 0</h6><p>慢启动阶段，就是当前拥塞窗口值比慢启动阈值(snd_ssthresh)小的时候，所处的阶段就叫做慢启动阶段。</p>
<p>当我们收到一个新的ACK时，则会调用tcp_slow_start()这个函数，并且为拥塞窗口增加1.(Linux中拥塞窗口的值代表数据包的个数，而不是实际的发送字节数目。实际可以发送的字节数等于可以发送的数据包个数*MSS。)<br>直到慢启动阶段出现数据包的丢失。<br>而引入了tcp_max_ssthresh 这个参数后，则可以控制在慢启动阶段拥塞窗口增加的频度。</p>
<p>默认这个参数不打开，如果这个参数的值设置为1000，则当拥塞窗口值大于1000时，</p>
<p>则没收到一个ACK，并不再增加拥塞窗口一个单位了，而是约收到2个ACK才增加一个窗口单位。收到2ACK并不是决定值！！<br>需要根据当前的拥塞窗口值，tcp_max_ssthresh值进行判断。</p>
<h6 id="net-ipv4-tcp-thin-linear-timeouts-x3D-0"><a href="#net-ipv4-tcp-thin-linear-timeouts-x3D-0" class="headerlink" title="net.ipv4.tcp_thin_linear_timeouts&#x3D; 0"></a>net.ipv4.tcp_thin_linear_timeouts&#x3D; 0</h6><p>这个函数RTO超时的处理函数。如果是thin流，则不要新设RTO是原先的2倍。</p>
<h6 id="net-ipv4-tcp-thin-dupack-x3D-0"><a href="#net-ipv4-tcp-thin-dupack-x3D-0" class="headerlink" title="net.ipv4.tcp_thin_dupack&#x3D; 0"></a>net.ipv4.tcp_thin_dupack&#x3D; 0</h6><p>与tcp_thin_linear_timeouts同为快速重传算法参数</p>
<h6 id="net-core-netdev-max-backlog-x3D-300"><a href="#net-core-netdev-max-backlog-x3D-300" class="headerlink" title="net.core.netdev_max_backlog&#x3D;300"></a>net.core.netdev_max_backlog&#x3D;300</h6><p>进入包的最大设备队列.默认是300,对重负载服务器而言,该值太低,可调整到1000。</p>
<h6 id="ip-link-set-eth0-mtu-1500"><a href="#ip-link-set-eth0-mtu-1500" class="headerlink" title="ip link set eth0 mtu 1500"></a>ip link set eth0 mtu 1500</h6><p>设置网卡mtu大小。</p>
<p>IP 相关部份</p>
<h6 id="net-ipv4-ip-local-port-range-x3D-1024-65000"><a href="#net-ipv4-ip-local-port-range-x3D-1024-65000" class="headerlink" title="net.ipv4.ip_local_port_range &#x3D; 1024 65000"></a>net.ipv4.ip_local_port_range &#x3D; 1024 65000</h6><p>表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。</p>
<h6 id="net-ipv4-ip-conntrack-max-x3D-655360"><a href="#net-ipv4-ip-conntrack-max-x3D-655360" class="headerlink" title="net.ipv4.ip_conntrack_max &#x3D; 655360"></a>net.ipv4.ip_conntrack_max &#x3D; 655360</h6><p>在内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）another</p>
<h6 id="避免放大攻击"><a href="#避免放大攻击" class="headerlink" title="避免放大攻击"></a>避免放大攻击</h6><p>net.ipv4.icmp_echo_ignore_broadcasts &#x3D; 1</p>
<h6 id="开启恶意icmp错误消息保护"><a href="#开启恶意icmp错误消息保护" class="headerlink" title="开启恶意icmp错误消息保护"></a>开启恶意icmp错误消息保护</h6><p>net.ipv4.icmp_ignore_bogus_error_responses &#x3D; 1</p>
<h6 id="开启SYN洪水攻击保护"><a href="#开启SYN洪水攻击保护" class="headerlink" title="开启SYN洪水攻击保护"></a>开启SYN洪水攻击保护</h6><p>net.ipv4.tcp_syncookies &#x3D; 1</p>
<h6 id="开启并记录欺骗，源路由和重定向包"><a href="#开启并记录欺骗，源路由和重定向包" class="headerlink" title="开启并记录欺骗，源路由和重定向包"></a>开启并记录欺骗，源路由和重定向包</h6><p>net.ipv4.conf.all.log_martians &#x3D; 1</p>
<p>net.ipv4.conf.default.log_martians &#x3D; 1</p>
<h6 id="处理无源路由的包"><a href="#处理无源路由的包" class="headerlink" title="处理无源路由的包"></a>处理无源路由的包</h6><p>net.ipv4.conf.all.accept_source_route &#x3D; 0</p>
<p>net.ipv4.conf.default.accept_source_route &#x3D; 0</p>
<h6 id="开启反向路径过滤"><a href="#开启反向路径过滤" class="headerlink" title="开启反向路径过滤"></a>开启反向路径过滤</h6><p>net.ipv4.conf.all.rp_filter &#x3D; 1</p>
<p>net.ipv4.conf.default.rp_filter &#x3D; 1</p>
<h6 id="确保无人能修改路由表"><a href="#确保无人能修改路由表" class="headerlink" title="确保无人能修改路由表"></a>确保无人能修改路由表</h6><p>net.ipv4.conf.all.accept_redirects &#x3D; 0</p>
<p>net.ipv4.conf.default.accept_redirects &#x3D; 0</p>
<p>net.ipv4.conf.all.secure_redirects &#x3D; 0</p>
<p>net.ipv4.conf.default.secure_redirects &#x3D; 0</p>
<h6 id="不充当路由器"><a href="#不充当路由器" class="headerlink" title="不充当路由器"></a>不充当路由器</h6><p>net.ipv4.ip_forward &#x3D; 0</p>
<p>net.ipv4.conf.all.send_redirects &#x3D; 0</p>
<p>net.ipv4.conf.default.send_redirects &#x3D; 0</p>
<h6 id="开启execshild"><a href="#开启execshild" class="headerlink" title="开启execshild"></a>开启execshild</h6><p>kernel.exec-shield &#x3D; 1</p>
<p>kernel.randomize_va_space &#x3D; 1</p>
<p>网络相关部份(&#x2F;sys)</p>
<h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-packets"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-packets" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_packets:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_packets:</h6><p>收到的数据包数据</p>
<h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-packets"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-packets" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_packets:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_packets:</h6><p>传输的数据包数量</p>
<h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-bytes"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-bytes" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_bytes:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_bytes:</h6><p>接收的字节数</p>
<h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-bytes"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-bytes" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_bytes:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_bytes:</h6><p>传输的字节数</p>
<h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-dropped"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-rx-dropped" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_dropped:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.rx_dropped:</h6><h6 id="收包时丢弃的数据包"><a href="#收包时丢弃的数据包" class="headerlink" title="收包时丢弃的数据包"></a>收包时丢弃的数据包</h6><h6 id="sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-dropped"><a href="#sys-x2F-class-x2F-net-x2F-eth0-x2F-statistics-tx-dropped" class="headerlink" title="sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_dropped:"></a>sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;statistics.tx_dropped:</h6><p>发包时丢弃的数据包</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/07/LAN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/07/LAN/" class="post-title-link" itemprop="url">LAN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-07 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-07T19:30:00+08:00">2022-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:59:08" itemprop="dateModified" datetime="2022-04-27T15:59:08+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-lan/" itemprop="url" rel="index"><span itemprop="name">linux lan</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="桥接"><a href="#桥接" class="headerlink" title="桥接"></a>桥接</h5><p>桥接是将多个网卡二层互联向在一个交换机上一样<br>桥接会产生一个网口br0 可以用来作为出口网关<br>brctl 为创建桥接的工具</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@zlhf:/home/butel/config# brctl <span class="keyword">help</span></span><br><span class="line">never heard of <span class="keyword">command</span> [<span class="keyword">help</span>]</span><br><span class="line">Usage: brctl [commands]</span><br><span class="line">commands:</span><br><span class="line">    addbr           <span class="symbol">&lt;bridge&gt;</span>                <span class="built_in">add</span> bridge</span><br><span class="line">    delbr           <span class="symbol">&lt;bridge&gt;</span>                <span class="keyword">delete</span> bridge</span><br><span class="line">    addif           <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;device&gt;</span>       <span class="built_in">add</span> interface <span class="keyword">to</span> bridge</span><br><span class="line">    delif           <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;device&gt;</span>       <span class="keyword">delete</span> interface from bridge</span><br><span class="line">    hairpin         <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;port&gt;</span> &#123;<span class="keyword">on</span>|off&#125;        turn hairpin <span class="keyword">on</span>/off</span><br><span class="line">    setageing       <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;time&gt;</span>         <span class="keyword">set</span> ageing time</span><br><span class="line">    setbridgeprio   <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;prio&gt;</span>         <span class="keyword">set</span> bridge priority</span><br><span class="line">    setfd           <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;time&gt;</span>         <span class="keyword">set</span> bridge forward delay</span><br><span class="line">    sethello        <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;time&gt;</span>         <span class="keyword">set</span> hello time</span><br><span class="line">    setmaxage       <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;time&gt;</span>         <span class="keyword">set</span> <span class="built_in">max</span> message age</span><br><span class="line">    setpathcost     <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;port&gt;</span> <span class="symbol">&lt;cost&gt;</span>  <span class="keyword">set</span> path cost</span><br><span class="line">    setportprio     <span class="symbol">&lt;bridge&gt;</span> <span class="symbol">&lt;port&gt;</span> <span class="symbol">&lt;prio&gt;</span>  <span class="keyword">set</span> port priority</span><br><span class="line">    show            [ <span class="symbol">&lt;bridge&gt;</span> ]            show <span class="keyword">a</span> <span class="keyword">list</span> of bridges</span><br><span class="line">    showmacs        <span class="symbol">&lt;bridge&gt;</span>                show <span class="keyword">a</span> <span class="keyword">list</span> of mac addrs</span><br><span class="line">    showstp         <span class="symbol">&lt;bridge&gt;</span>                show bridge stp info</span><br><span class="line">    stp             <span class="symbol">&lt;bridge&gt;</span> &#123;<span class="keyword">on</span>|off&#125;       turn stp <span class="keyword">on</span>/off</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将LAN口IP设置为  10.42.0.129<br>并仿照WIFI的模式启动 dnsmasq 启动 DHCP server 为接入者分配IP<br>使用桥接将LAN口全部桥接起来<br>并在br0上设置网关IP  10.42.0.129</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/06/iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/06/iptables/" class="post-title-link" itemprop="url">udhcpc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-06 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-06T19:30:00+08:00">2022-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:58:58" itemprop="dateModified" datetime="2022-04-27T15:58:58+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-iptables/" itemprop="url" rel="index"><span itemprop="name">linux iptables</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux下的iptables"><a href="#Linux下的iptables" class="headerlink" title="Linux下的iptables"></a>Linux下的iptables</h2><hr>
<p>iptables 作为一个客户端代理，通过iptables可以将用户的安全设定配置到防火墙中。<br>netfilter才是防火墙真正的安全框架（framework），netfilter位于内核空间</p>
<hr>
<h2 id="Netfitler"><a href="#Netfitler" class="headerlink" title="Netfitler"></a>Netfitler</h2><p>当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p>
<p>做NAT操作需要保证系统开启ipv4转发<br>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward&#x3D;1</p>
<h4 id="例子-将192-168-0-12的7788端口数据转发到192-168-0-11的7799端口"><a href="#例子-将192-168-0-12的7788端口数据转发到192-168-0-11的7799端口" class="headerlink" title="例子: 将192.168.0.12的7788端口数据转发到192.168.0.11的7799端口"></a>例子: 将192.168.0.12的7788端口数据转发到192.168.0.11的7799端口</h4><p>思路:<br>    把发到本机7788端口的数据包转到0.11:7799<br>    把本机要发到0.11:7799的数据包源地址改为本机地址</p>
<p>iptables -t nat -A PREROUTEING -p tcp –dport 7788 -j DNAT –to 192.168.0.11:7788</p>
<p>iptables -t nat -A POSTROUTING -p tcp -d 192.168.0.11 –dport 7799 -j SNAT –to 192.168.0.12</p>
<p>-j SNAT –to 192.168.0.12可写为 -j MASQUERADE(默认转为出口网卡的ip地址)</p>
<h5 id="聚合做NAT"><a href="#聚合做NAT" class="headerlink" title="聚合做NAT"></a>聚合做NAT</h5><p>iptables -t nat -A POSTROUTING -s $ip&#x2F;$masq_ip_mask  -j MASQUERADE</p>
<h5 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h5><p>在PREROUTINGREDIRECT中有没有将数据重定向到1080端口的规则<br>sudo iptables -t nat -vnL PREROUTINGREDIRECT –line-number | awk ‘{print $NF}’|grep 1080</p>
<p>sudo iptables -t nat -A PREROUTINGREDIRECT -p tcp -s 172.31.0.0&#x2F;16 -j REDIRECT –to-ports 1080</p>
<h5 id="开放端口-accept"><a href="#开放端口-accept" class="headerlink" title="开放端口 accept"></a>开放端口 accept</h5><p>sudo iptables -t nat -A OUTPUTPASS -p tcp –dport 22 -J ACCEPT</p>
<h5 id="设置pmtu"><a href="#设置pmtu" class="headerlink" title="设置pmtu"></a>设置pmtu</h5><ol>
<li>多表中添加 –damp-mss-to-pmtu</li>
<li>保证TCP数据经过MTU较小的tun0时能够正确的分包</li>
</ol>
<p>为达到最佳的传输效能TCP在建立连接时会协商MSS（最大分段长度，一般为1460字节）值，即MTU（最大传输单元，不超过1500字节）减去IP数据包包头20字节和TCP数据包头20字节，取最小的MSS值为本次连接的最大MSS值，Iptables下TCPMSS模块即用来调整TCP数据包中MSS数值。<br>在ADSL拨号环境中由于PPP包头占用8字节，MTU为1492字节，MSS为1452字节，如不能正确设置会导致网络不正常，可以通过TCPMSS模块调整MSS大小。<br>TCPMSS使用参数：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http://www.haiyun.me</span></span><br><span class="line"><span class="built_in">--set-mss</span> <span class="string">value</span> <span class="comment">#设置特定MSS值</span></span><br><span class="line"><span class="built_in">--clamp-mss-to-pmtu</span> <span class="comment">#根据MTU自动调整MS</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -<span class="selector-tag">I</span> POSTROUTING -o pppoe-wan -<span class="selector-tag">p</span> tcp -m tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span> </span><br><span class="line">#自动调整经pppoe-wan接口发出的TCP数据MSS</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#echo</span> &quot;set mss&quot;</span><br><span class="line">iptables -t mangle -<span class="selector-tag">I</span> FORWARD -o tun+ -<span class="selector-tag">p</span> tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span></span><br><span class="line">iptables -t mangle -<span class="selector-tag">I</span> FORWARD -<span class="selector-tag">i</span> wlan+ -<span class="selector-tag">p</span> tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span></span><br><span class="line">iptables -t mangle -<span class="selector-tag">I</span> FORWARD -<span class="selector-tag">i</span> br+ -<span class="selector-tag">p</span> tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span></span><br><span class="line">iptables -t mangle -<span class="selector-tag">A</span> OUTPUT -o tun+ -<span class="selector-tag">p</span> tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span></span><br><span class="line">iptables -t mangle -<span class="selector-tag">A</span> POSTROUTING -<span class="selector-tag">p</span> tcp <span class="attr">--tcp-flags</span> SYN,RST SYN -j TCPMSS <span class="attr">--clamp-mss-to-pmtu</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>设置完结果为</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span>@zlhf:/home/butel/config# iptables -t mangle -vnL</span><br><span class="line"><span class="attribute">Chain</span> PREROUTING (policy ACCEPT <span class="number">5164</span>K packets, <span class="number">1815</span>M bytes)</span><br><span class="line"> <span class="attribute">pkts</span> bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line"><span class="attribute">Chain</span> INPUT (policy ACCEPT <span class="number">5131</span>K packets, <span class="number">1803</span>M bytes)</span><br><span class="line"> <span class="attribute">pkts</span> bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line"><span class="attribute">Chain</span> FORWARD (policy ACCEPT <span class="number">31511</span> packets, <span class="number">11</span>M bytes)</span><br><span class="line"> <span class="attribute">pkts</span> bytes target     prot opt in     out     source               destination</span><br><span class="line">    <span class="attribute">0</span>     <span class="number">0</span> TCPMSS     tcp  --  br+    *       <span class="number">0.0.0.0</span>/<span class="number">0</span>            <span class="number">0.0.0.0</span>/<span class="number">0</span>            tcp flags:<span class="number">0</span>x06/<span class="number">0</span>x02 TCPMSS clamp to PMTU</span><br><span class="line">   <span class="attribute">76</span>  <span class="number">3952</span> TCPMSS     tcp  --  wlan+  *       <span class="number">0.0.0.0</span>/<span class="number">0</span>            <span class="number">0.0.0.0</span>/<span class="number">0</span>            tcp flags:<span class="number">0</span>x06/<span class="number">0</span>x02 TCPMSS clamp to PMTU</span><br><span class="line">   <span class="attribute">19</span>   <span class="number">988</span> TCPMSS     tcp  --  *      tun+    <span class="number">0.0.0.0</span>/<span class="number">0</span>            <span class="number">0.0.0.0</span>/<span class="number">0</span>            tcp flags:<span class="number">0</span>x06/<span class="number">0</span>x02 TCPMSS clamp to PMTU</span><br><span class="line"></span><br><span class="line"><span class="attribute">Chain</span> OUTPUT (policy ACCEPT <span class="number">5100</span>K packets, <span class="number">1435</span>M bytes)</span><br><span class="line"> <span class="attribute">pkts</span> bytes target     prot opt in     out     source               destination</span><br><span class="line"><span class="attribute">25899</span> <span class="number">1865</span>K TCPMSS     tcp  --  *      tun+    <span class="number">0.0.0.0</span>/<span class="number">0</span>            <span class="number">0.0.0.0</span>/<span class="number">0</span>            tcp flags:<span class="number">0</span>x06/<span class="number">0</span>x02 TCPMSS clamp to PMTU</span><br><span class="line"></span><br><span class="line"><span class="attribute">Chain</span> POSTROUTING (policy ACCEPT <span class="number">5131</span>K packets, <span class="number">1446</span>M bytes)</span><br><span class="line"> <span class="attribute">pkts</span> bytes target     prot opt in     out     source               destination</span><br><span class="line"> <span class="attribute">115K</span> <span class="number">8065</span>K TCPMSS     tcp  --  *      *       <span class="number">0.0.0.0</span>/<span class="number">0</span>            <span class="number">0.0.0.0</span>/<span class="number">0</span>            tcp flags:<span class="number">0</span>x06/<span class="number">0</span>x02 TCPMSS clamp to PMTU</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="网络中的mss与mtu相关"><a href="#网络中的mss与mtu相关" class="headerlink" title="网络中的mss与mtu相关"></a>网络中的mss与mtu相关</h4><p> 关于mtu和mss 网上的资料很多，在看《tcp&#x2F;ip详解卷1》的时候里面重点说了下mtu的重要性. 但是却没找到mss，或许是因为mss是tcp层的一个概念吧，当然mss和mtu也有莫大的关系.这里为什么再写一下，是因为在实际工作中，前方测试遇到的一个奇怪问题. 解决完之后，做一个总结而已.<br>     那么什么奇怪的问题呢？ 就是大部分网站能上去，有些网站上不去. 或许经常玩网络设备的人马上就会想到了mtu或者mss ，当时我们没有遇到过.并没有发现问题！通过网络接口抓包也没有发现什么… 因为在家里测试没有问题.所以只有环境的问题了，那么问题出在了什么地方呢？ </p>
<h5 id="这里先说说mtu"><a href="#这里先说说mtu" class="headerlink" title="这里先说说mtu"></a>这里先说说mtu</h5><p>mtu是一个链路层的一个概念，mtu的定义：除去帧头的数据包大小.RFC 894（以太网）<br>以太网帧报头为 目的地址 6+源地址 6+协议类型 2+CRC 4&#x3D;18 bytes<br> 所以一般以太网mtu最大是1500 ，而对于ppp还要减去8字节的开销，就是1492字节.<br>我们就从lan到wan数据包的流程说起吧.<br>首先pc会发送一个数据帧，一般模式1500（mtu）.虽然有mtu协商的功能，但是有时候并不那么智能.这里举例：<br>#ping  -f -l  2000   x.x.x.x<br>这里ping一个大包 ，并且不允许分片.<br>#来自 x.x.x.x 的回复: 需要拆分数据包但是设置 DF。<br>有时候网络中pc会发一个我们认为合理的包，但是不通.首先pc发送的数据帧，先达到switch芯片,那么switch一般会允许多大的帧通过呢？<br>这里我们简单的参考6097的一个芯片. 默认是允许1522的帧（tag） 1518 （untag） ，如果开启了超大帧模式，为1632.<br>而对于lan侧，或许我们调整可以接收的范围就行了.当然很多时候pc不会发送一个那么大的帧. 如果是从vlan到pc呢？<br>首先对于一个网络设备，从tcp&#x2F;udp层封包，往下面传递，到vlan，加tag，封帧，驱动发送.所以vlan所允许的mtu很重要，或许发送给pc的帧，pc不能接受!<br>如果vlan的mtu为1500 ，那么最大可以发送出去的帧为1522 （tag） ，1518（untag） .<br>所以在ip层，如果ip包大于mtu值，会分片小于mtu.并发送出去. 这里并不讲数据包的收发具体的函数流程.<br>但是实际中我们需要上网，就需要wan—lan之间的数据通信. 一般我们的路由器会pppoe拨号，即wan口. 我们知道对于pppoe的帧，它会附加8字节的pppoe头信息，所以一般默认的pppoe所允许的mtu大小为1500-8&#x3D;1492 .<br>这里附加说明一下对于icmp包的，ip头长度默认是28字节，而一般ip头位20字节，（默认没有附加字段）。<br>2. 在ip foward的时候会检查mss和mtu值.决定是否分片.而mss和tcp连接有关.<br>一般在tcp建立连接的时候，双方会协商出来一个最小的mss值，因为一般tcp通信中一些数据包不允许分片.所以需要在发送的时候，直接发送一个比较小的数据报文.<br>不然就会被网络处理的时候丢弃掉.<br>我们来看看mss的定义：<br>MSS： Maxitu Segment Size 最大分段大小<br>它是tcp数据包每次能够传输的最大数据分段.为了达到最佳的传输效能，tcp<br>协议在建立连接的时候通常要协商双方的MSS值，这个值一般是减去ip头和tcp头<br>即1460，<br>而有时候我们会遇到一些问题：<br>MSS—路径最大传输单元 (PMTU) 黑洞路由器  当路由器必须将 IP 包分段但又因 DF 标记设置为 1 而不能分段时，路由器可采用以下任一种方式：</p>
<ol>
<li>发送符合 RFC 792 中最初定义的“ICMP Destination Unreachable-Fragmentation Needed and DF Set”消息，然后丢弃该包。  原始消息格式中不包含有关转发失败的链路的 IP MTU 的信息。</li>
<li>发送符合 RFC 1191 中重新定义的“ICMP Destination Unreachable-Fragmentation Needed and DF Set”消息，然后丢弃该包。此新消息格式包含一个 MTU 字段，可指出转发失败的链路的 IP MTU。   RFC 1191 定义了路径 MTU (PMTU) 发现，它使得成对的 TCP 对等方能够动态地发现二者之间路径的 IP MTU，从而发现该路径的 TCP MSS。一旦收到符合 RFC 1191 定义的“Destination Unreachable-Fragmentation Needed and DF Set”消息，TCP 就会将该连接的 MSS 调整为指定 IP MTU 减去 TCP 和 IP 报头的大小。这样，在该 TCP 连接上发送的后续包就不会超过最大大小，无需分段即可在该路径上传输。 </li>
<li>直接丢弃包。   直接丢弃需分段但 DF 标记设置为 1 的包的路由器称为 PMTU 黑洞路由器。</li>
</ol>
<p>PMTU 黑洞路由器会给 TCP 连接带来问题<br>在 TCP 三次握手期间交换的 TCP 数据段不会太大，因而不会被 PMTU 黑洞路由器丢弃。但是，一旦开始在连接上传输数据—假定基于协商的 MSS 确定的 PMTU 比实际 PMTU 大—TCP 数据段的大于实际 PMTU 的 IP 包就会被直接丢弃<br>是的，有时候我们不能保证每个网络设备都有（2）中，mtu自动发现功能. 对于涉及PPPOE＋NAT、IPsec、L2TP、GRE等组网，通常由于报文太大需要分片，这样会降低传输速率; 所以选择一个合适的MSS对传输数据来说比较重要.<br>linux中一般可以通过netfilter iptables设置TCP MSS来解决<br><code>iptables -A FORWARD -p tcp- -tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code></p>
<p>这条规则的目的就是改变TCP MSS以适应PMTU(Path MTU)<br><code>iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN- j TCPMSS --set-mss 128</code><br>设置MSS为128</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/06/udhcpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/06/udhcpc/" class="post-title-link" itemprop="url">udhcpc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-06 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-06T19:30:00+08:00">2022-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:58:53" itemprop="dateModified" datetime="2022-04-27T15:58:53+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-udhcpc/" itemprop="url" rel="index"><span itemprop="name">linux udhcpc</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>指定dhcp脚本进行dhcp获取ip</p>
<h6 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h6><p> busybox udhcpc -i eth0 -s &#x2F;home&#x2F;butel&#x2F;4GFusion&#x2F;sh&#x2F;udhcpc.script</p>
<h6 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">. /home/butel/4GFusion/sh/fuslog.sh</span><br><span class="line"><span class="comment"># Busybox udhcpc dispatcher script.</span></span><br><span class="line"><span class="comment"># Copyright (C) 2009 by Axel Beckert.</span></span><br><span class="line"><span class="comment"># Copyright (C) 2014 by Michael Tokarev.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Based on the busybox example scripts and the old udhcp source</span></span><br><span class="line"><span class="comment"># package default.* scripts.</span></span><br><span class="line"></span><br><span class="line">RESOLV_CONF=<span class="string">&quot;/etc/resolv.conf&quot;</span></span><br><span class="line">config_dir=<span class="string">&quot;/home/butel/config/&quot;</span></span><br><span class="line">json_file=<span class="string">&quot;/home/butel/config/interface.json&quot;</span>  </span><br><span class="line">route_table_id=122</span><br><span class="line"></span><br><span class="line">wan_ifname_list=()</span><br><span class="line">wan_config_name_list=()</span><br><span class="line">wan_dhcponoff_list=()</span><br><span class="line">table_name_list=()</span><br><span class="line">config_file_list=()</span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -A ethmap</span><br><span class="line">ethmap=([<span class="string">&quot;eth0&quot;</span>]=<span class="string">&quot;100&quot;</span> [<span class="string">&quot;eth1&quot;</span>]=<span class="string">&quot;200&quot;</span> [<span class="string">&quot;eth2&quot;</span>]=<span class="string">&quot;300&quot;</span> [<span class="string">&quot;eth3&quot;</span>]=<span class="string">&quot;400&quot;</span> [<span class="string">&quot;eth4&quot;</span>]=<span class="string">&quot;500&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_info_list</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    interfaces=`<span class="built_in">cat</span> <span class="variable">$json_file</span> | jq <span class="string">&#x27;.interfaces[].interface&#x27;</span> | sed <span class="string">&#x27;s/\&quot;//g&#x27;</span>`</span><br><span class="line">	arrinterfafce=(<span class="variable">$interfaces</span>)</span><br><span class="line">	length=`<span class="built_in">echo</span> <span class="variable">$&#123;#arrinterfafce[@]&#125;</span>`</span><br><span class="line">    ipfilelist=()</span><br><span class="line">    <span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</span><br><span class="line">    <span class="keyword">do</span>  </span><br><span class="line">        interfacetype=`<span class="built_in">cat</span> <span class="variable">$json_file</span> | jq <span class="string">&#x27;.interfaces[&#x27;</span><span class="variable">$i</span><span class="string">&#x27;].type&#x27;</span> | sed  <span class="string">&quot;s/\&quot;//g&quot;</span>`</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$interfacetype</span> = <span class="string">&quot;WAN&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">            inter=`<span class="built_in">cat</span> <span class="variable">$json_file</span> | jq <span class="string">&#x27;.interfaces[&#x27;</span><span class="variable">$i</span><span class="string">&#x27;].interface&#x27;</span> | sed  <span class="string">&quot;s/\&quot;//g&quot;</span> `</span><br><span class="line">            ipfile=` <span class="built_in">cat</span> <span class="variable">$json_file</span> | jq <span class="string">&#x27;.interfaces[&#x27;</span><span class="variable">$i</span><span class="string">&#x27;].ipfile&#x27;</span> | sed <span class="string">&quot;s/\&quot;//g&quot;</span> `</span><br><span class="line">            config_file=` <span class="built_in">echo</span> <span class="variable">$&#123;ipfile##*/&#125;</span> `</span><br><span class="line">            </span><br><span class="line">			table_name=`<span class="built_in">cat</span> <span class="variable">$json_file</span> | jq <span class="string">&#x27;.interfaces[&#x27;</span><span class="variable">$i</span><span class="string">&#x27;].subroute&#x27;</span> | sed <span class="string">&quot;s/\&quot;//g&quot;</span> `</span><br><span class="line">            table_name_list+=(<span class="variable">$table_name</span>)</span><br><span class="line">            netonoff=`sed -n <span class="string">&#x27;6p&#x27;</span> <span class="variable">$&#123;ipfile&#125;</span>`</span><br><span class="line">            config_file_name=` <span class="built_in">echo</span> <span class="variable">$&#123;ipfile##*/&#125;</span> `</span><br><span class="line">			<span class="comment"># 未启用的网卡不进行 地址冲突判断</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;netonoff&#125;</span>&quot;</span> == <span class="string">&quot;enable&quot;</span> ];</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                 wan_ifname_list+=(<span class="variable">$inter</span>)</span><br><span class="line">                 wan_config_name_list+=(<span class="variable">$config_file_name</span>)</span><br><span class="line">				 config_file_list+=(<span class="variable">$config_file</span>) </span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    logger -t <span class="string">&quot;uchcpc[<span class="variable">$PPID</span>]&quot;</span> -p daemon.<span class="variable">$1</span> <span class="string">&quot;<span class="variable">$interface</span>: <span class="variable">$2</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mask2cdr</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment"># http://ju.outofmemory.cn/entry/330060</span></span><br><span class="line">   <span class="built_in">local</span> x=<span class="variable">$&#123;1##*255.&#125;</span></span><br><span class="line">   <span class="built_in">set</span> -- 0^^^128^192^224^240^248^252^254^ $(( (<span class="variable">$&#123;#1&#125;</span> - <span class="variable">$&#123;#x&#125;</span>)*<span class="number">2</span> )) <span class="variable">$&#123;x%%.*&#125;</span></span><br><span class="line">   x=<span class="variable">$&#123;1%%$3*&#125;</span></span><br><span class="line">   <span class="built_in">return</span> $(( <span class="variable">$2</span> + (<span class="variable">$&#123;#x&#125;</span>/<span class="number">4</span>) ))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 修改部分    与其他网卡也进行比较</span></span><br><span class="line"><span class="comment"># 配置文件信息改为如下</span></span><br><span class="line"><span class="comment"># 10.160.94.66</span></span><br><span class="line"><span class="comment"># 255.255.255.0</span></span><br><span class="line"><span class="comment"># 10.160.94.1</span></span><br><span class="line"><span class="comment"># 114.114.114.1  114.114.114.2</span></span><br><span class="line"><span class="function"><span class="title">check_wan0_network_setting</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;start&quot;</span></span><br><span class="line">	<span class="comment"># return 0</span></span><br><span class="line">	my_name=<span class="variable">$1</span></span><br><span class="line">	<span class="built_in">local</span> ip=<span class="variable">$2</span></span><br><span class="line">	<span class="built_in">local</span> gateway=<span class="variable">$3</span></span><br><span class="line">	lenght=<span class="variable">$&#123;#wan_ifname_list[@]&#125;</span></span><br><span class="line">	<span class="comment"># 检查wan口里面IP或网关</span></span><br><span class="line">	<span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$&#123;lenght&#125;</span>;i++));</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		other_config_name=<span class="variable">$&#123;wan_config_name_list[i]&#125;</span>   <span class="comment"># eth0set eth1set eth2set</span></span><br><span class="line">		other_name=<span class="variable">$&#123;wan_ifname_list[i]&#125;</span>				<span class="comment"># eth0  eth1 eth2</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$other_name</span>&quot;</span> != <span class="string">&quot;<span class="variable">$my_name</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">            <span class="comment"># other 为 dhcp  修改-&gt;  读配置文件  为on  </span></span><br><span class="line">			<span class="built_in">local</span> other_dhcp=`sed -n <span class="string">&quot;7p&quot;</span> $config_dir<span class="variable">$other_config_name</span>`</span><br><span class="line">			<span class="built_in">local</span> other_running=`ifconfig <span class="variable">$other_name</span> | grep RUNNING`</span><br><span class="line">			<span class="comment">#启动dhcp的非连接网卡的记录不进行对比，其他全部需要对比  -&gt; == &quot;on&quot; and other_running 为空 说明 启动了dhcp但未连接 不进行对比</span></span><br><span class="line">			<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$other_dhcp</span>&quot;</span> = <span class="string">&quot;on&quot;</span> -a -z <span class="string">&quot;<span class="variable">$other_running</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				<span class="built_in">continue</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			<span class="comment"># 4p-&gt;1p   6p -&gt;3p</span></span><br><span class="line">			<span class="built_in">local</span> otherip=`sed -n <span class="string">&quot;1p&quot;</span> $config_dir<span class="variable">$other_config_name</span>`</span><br><span class="line">			<span class="built_in">local</span> othergw=`sed -n <span class="string">&quot;3p&quot;</span> $config_dir<span class="variable">$other_config_name</span>`</span><br><span class="line">			<span class="comment"># 判断是否ip冲突</span></span><br><span class="line">			<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$otherip</span>&quot;</span> = <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> -o <span class="string">&quot;<span class="variable">$othergw</span>&quot;</span> = <span class="string">&quot;<span class="variable">$gateway</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				<span class="built_in">echo</span> <span class="string">&quot;failed:<span class="variable">$other_name</span>,<span class="variable">$my_name</span>,<span class="variable">$otherip</span>,<span class="variable">$ip</span>,<span class="variable">$othergw</span>,<span class="variable">$gateway</span>&quot;</span></span><br><span class="line">				flog error  <span class="string">&quot;failed:<span class="variable">$other_name</span>,<span class="variable">$my_name</span>,<span class="variable">$otherip</span>,<span class="variable">$ip</span>,<span class="variable">$othergw</span>,<span class="variable">$gateway</span>&quot;</span></span><br><span class="line">				<span class="built_in">return</span> 1</span><br><span class="line">			<span class="keyword">fi</span>		</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	<span class="built_in">return</span> 0</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 保存信息</span></span><br><span class="line"><span class="function"><span class="title">save_config</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">local</span> intface=<span class="variable">$1</span></span><br><span class="line">	<span class="built_in">local</span> ipp=<span class="variable">$2</span></span><br><span class="line">	<span class="built_in">local</span> subnett=<span class="variable">$3</span></span><br><span class="line">	<span class="built_in">local</span> routerr=<span class="variable">$4</span></span><br><span class="line">	<span class="built_in">local</span> state=<span class="variable">$5</span></span><br><span class="line">	<span class="built_in">local</span> length=<span class="variable">$&#123;#wan_ifname_list[@]&#125;</span></span><br><span class="line">	<span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$&#123;length&#125;</span>;i++));</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		other_config_name=<span class="variable">$&#123;wan_config_name_list[i]&#125;</span></span><br><span class="line">		other_intface=<span class="variable">$&#123;wan_ifname_list[i]&#125;</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$other_config_name</span> <span class="variable">$other_intface</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$intface</span>&quot;</span> = <span class="string">&quot;<span class="variable">$other_intface</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">			sed -i <span class="string">&quot;1c <span class="variable">$ipp</span>&quot;</span> $config_dir<span class="variable">$other_config_name</span></span><br><span class="line">			sed -i <span class="string">&quot;2c <span class="variable">$subnett</span>&quot;</span> $config_dir<span class="variable">$other_config_name</span></span><br><span class="line">			sed -i <span class="string">&quot;3c <span class="variable">$routerr</span>&quot;</span> $config_dir<span class="variable">$other_config_name</span></span><br><span class="line">			sed -i <span class="string">&quot;5c <span class="variable">$state</span>&quot;</span> $config_dir<span class="variable">$other_config_name</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$dns</span>&quot;</span> &gt; /dev/shm/<span class="variable">$interface</span></span><br><span class="line">			flog debug <span class="string">&quot;<span class="variable">$other_intface</span> <span class="variable">$ipp</span> <span class="variable">$ipp</span> <span class="variable">$routerr</span> <span class="variable">$state</span> <span class="variable">$dns</span>&quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_ip</span></span>()&#123;</span><br><span class="line">    ubuntu_ifname=<span class="variable">$1</span></span><br><span class="line">    <span class="comment"># Ubuntu version 16 or 18 </span></span><br><span class="line">    is_ubuntu18=` <span class="built_in">cat</span> /etc/issue | grep 18`</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$is_ubuntu18</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        ip=`ifconfig <span class="variable">$ubuntu_ifname</span> 2&gt;/dev/null | grep <span class="string">&quot;inet&quot;</span> | grep netmask | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ip=` ifconfig <span class="variable">$ubuntu_ifname</span> 2&gt;/dev/null | grep <span class="string">&quot;inet addr&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&quot;:&quot;</span> -f 2 `</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取相应的subroute  </span></span><br><span class="line"><span class="function"><span class="title">set_iproute</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;set_iproute&quot;</span></span><br><span class="line">	length=<span class="variable">$&#123;#wan_ifname_list[@]&#125;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;length&quot;</span></span><br><span class="line">	<span class="keyword">for</span>  ((i=0;i&lt;<span class="variable">$&#123;length&#125;</span>;i++))</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="variable">$&#123;wan_ifname_list[$i]&#125;</span> = <span class="variable">$interface</span> ];<span class="keyword">then</span></span><br><span class="line">			config_file=$config_dir<span class="variable">$&#123;config_file_list[$i]&#125;</span></span><br><span class="line">			lanroute=<span class="variable">$&#123;table_name_list[$i]&#125;</span></span><br><span class="line">	</span><br><span class="line">			<span class="built_in">echo</span> <span class="variable">$config_file</span>  <span class="variable">$lanroute</span></span><br><span class="line">			<span class="built_in">local</span> lanip=<span class="string">&quot;&quot;</span></span><br><span class="line">			<span class="built_in">local</span> lanmask=<span class="string">&quot;&quot;</span></span><br><span class="line">			<span class="built_in">local</span> gateway=<span class="string">&quot;&quot;</span>	</span><br><span class="line">			lanip=`sed -n <span class="string">&quot;1p&quot;</span> <span class="variable">$config_file</span>`</span><br><span class="line">			lanmask=`sed -n <span class="string">&quot;2p&quot;</span> <span class="variable">$config_file</span>`</span><br><span class="line">			gateway=`sed -n <span class="string">&quot;3p&quot;</span> <span class="variable">$config_file</span>`</span><br><span class="line">		</span><br><span class="line">			<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$lanip</span>&quot;</span> -o -z <span class="string">&quot;<span class="variable">$lanmask</span>&quot;</span> -o -z <span class="string">&quot;<span class="variable">$gateway</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				<span class="built_in">return</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			ip=<span class="string">&quot;&quot;</span></span><br><span class="line">			get_ip <span class="variable">$interface</span></span><br><span class="line">			sys_lanip=<span class="variable">$ip</span></span><br><span class="line">			rule_ip=`ip rule | grep <span class="string">&quot;from <span class="variable">$sys_lanip</span> lookup r<span class="variable">$interface</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>`</span><br><span class="line">			iproute=`ip route show table <span class="variable">$lanroute</span>`</span><br><span class="line">			<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$sys_lanip</span>&quot;</span> != <span class="string">&quot;<span class="variable">$lanip</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				<span class="built_in">return</span> </span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$lanip</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">				ip route flush table <span class="variable">$lanroute</span> </span><br><span class="line">				ip rule del table <span class="variable">$lanroute</span></span><br><span class="line">			<span class="keyword">elif</span> [ -z <span class="string">&quot;<span class="variable">$rule_ip</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				ip rule add from <span class="variable">$lanip</span> table <span class="variable">$lanroute</span></span><br><span class="line">				ip route add default via <span class="variable">$gateway</span> dev <span class="variable">$interface</span> table <span class="variable">$lanroute</span></span><br><span class="line">			<span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$lanip</span>&quot;</span> != <span class="string">&quot;<span class="variable">$rule_ip</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				ip rule del table <span class="variable">$lanroute</span></span><br><span class="line">				ip rule add from <span class="variable">$lanip</span> table <span class="variable">$lanroute</span></span><br><span class="line">				ip route add default via <span class="variable">$gateway</span> dev <span class="variable">$interface</span> table <span class="variable">$lanroute</span></span><br><span class="line">			<span class="keyword">elif</span> [ -z <span class="string">&quot;<span class="variable">$iproute</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">				ip route add default via <span class="variable">$gateway</span> dev <span class="variable">$interface</span> table <span class="variable">$lanroute</span></span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			<span class="comment"># 设置默认路由 </span></span><br><span class="line">			<span class="comment"># 设置优先级的默认路由</span></span><br><span class="line">			<span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable">$&#123;!ethmap[*]&#125;</span>;<span class="keyword">do</span></span><br><span class="line">				<span class="keyword">if</span> [ <span class="variable">$interface</span> = <span class="variable">$key</span> ];<span class="keyword">then</span></span><br><span class="line">					ip route add default via <span class="variable">$gateway</span> dev <span class="variable">$interface</span> metric <span class="variable">$&#123;ethmap[$key]&#125;</span></span><br><span class="line">					ip route add default via <span class="variable">$gateway</span> dev <span class="variable">$interface</span> metric <span class="variable">$&#123;ethmap[$key]&#125;</span> table <span class="variable">$route_table_id</span></span><br><span class="line">					flog debug <span class="string">&quot;set <span class="variable">$interface</span> metric finish&quot;</span></span><br><span class="line">					<span class="built_in">break</span></span><br><span class="line">				<span class="keyword">fi</span></span><br><span class="line">			<span class="keyword">done</span></span><br><span class="line"> 			ip route flush cache  </span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get_info_list</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    bound|renew)</span><br><span class="line">	check_wan0_network_setting <span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$router</span></span><br><span class="line">	<span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span>     <span class="comment"># 返回0，说明没有其他网口产生冲突，开始配置新ip</span></span><br><span class="line">		<span class="comment"># Configure new IP address. 配置新IP地址</span></span><br><span class="line">		<span class="comment"># Do it unconditionally even if the address hasn&#x27;t changed,</span></span><br><span class="line">		<span class="comment"># to also set subnet, broadcast, mtu, ...</span></span><br><span class="line">		busybox ifconfig <span class="variable">$interface</span> <span class="variable">$&#123;mtu:+mtu $mtu&#125;</span> \</span><br><span class="line">			<span class="variable">$ip</span> netmask <span class="variable">$subnet</span> <span class="variable">$&#123;broadcast:+broadcast $broadcast&#125;</span></span><br><span class="line">		</span><br><span class="line">		save_config <span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> <span class="variable">$router</span>  <span class="string">&quot;good&quot;</span></span><br><span class="line">		<span class="keyword">if</span> [ -f /dev/shm/DEBUG ];<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check success&quot;</span> &gt;&gt; /dev/kmsg</span><br><span class="line">			flog debug <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check success&quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check success&quot;</span></span><br><span class="line">		ip route add <span class="variable">$&#123;ip%.*&#125;</span>.0/<span class="variable">$mask</span> dev <span class="variable">$interface</span> table <span class="variable">$route_table_id</span></span><br><span class="line">	<span class="keyword">else</span>      <span class="comment"># 出现ip冲突   </span></span><br><span class="line">		<span class="keyword">if</span> [ -f /dev/shm/DEBUG ];<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check failed&quot;</span> &gt;&gt; /dev/kmsg</span><br><span class="line">			flog debug <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check failed&quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$interface</span> <span class="variable">$ip</span> <span class="variable">$subnet</span> check failed&quot;</span></span><br><span class="line">	        busybox ip <span class="built_in">link</span> <span class="built_in">set</span> <span class="variable">$interface</span> up</span><br><span class="line">	        busybox ip -4 addr flush dev <span class="variable">$interface</span></span><br><span class="line">	        busybox ip -4 route flush dev <span class="variable">$interface</span></span><br><span class="line">		save_config <span class="variable">$interface</span>  <span class="string">&quot;\ &quot;</span> <span class="string">&quot;\ &quot;</span> <span class="string">&quot;\ &quot;</span> <span class="string">&quot;conflict&quot;</span>	</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 已连接无IP  已连接获得IP重复  已连接有IP</span></span><br><span class="line">	<span class="comment"># Update resolver configuration file</span></span><br><span class="line">	[ -n <span class="string">&quot;<span class="variable">$domain</span>&quot;</span> ] &amp;&amp; R=<span class="string">&quot;domain <span class="variable">$domain</span>&quot;</span> || R=<span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$dns</span>; <span class="keyword">do</span></span><br><span class="line">	    R=<span class="string">&quot;<span class="variable">$R</span></span></span><br><span class="line"><span class="string">nameserver <span class="variable">$i</span>&quot;</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> [ -x /sbin/resolvconf ]; <span class="keyword">then</span></span><br><span class="line">	    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$R</span>&quot;</span> | resolvconf -a <span class="string">&quot;<span class="variable">$interface</span>.udhcpc&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$R</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$RESOLV_CONF</span>&quot;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">log</span> info <span class="string">&quot;<span class="variable">$1</span>: IP=<span class="variable">$ip</span>/<span class="variable">$subnet</span> router=<span class="variable">$router</span> domain=\&quot;<span class="variable">$domain</span>\&quot; dns=\&quot;<span class="variable">$dns</span>\&quot; lease=<span class="variable">$lease</span>&quot;</span></span><br><span class="line">	;;</span><br><span class="line"></span><br><span class="line">    deconfig)</span><br><span class="line">	<span class="keyword">if</span> [ -f /dev/shm/DEBUG ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;deconfig <span class="variable">$interface</span>&quot;</span> &gt; /dev/kmsg</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	busybox ip <span class="built_in">link</span> <span class="built_in">set</span> <span class="variable">$interface</span> up</span><br><span class="line">	busybox ip -4 addr flush dev <span class="variable">$interface</span></span><br><span class="line">	busybox ip -4 route flush dev <span class="variable">$interface</span></span><br><span class="line">	[ -x /sbin/resolvconf ] &amp;&amp;</span><br><span class="line">	    resolvconf -d <span class="string">&quot;<span class="variable">$interface</span>.udhcpc&quot;</span></span><br><span class="line">	<span class="built_in">log</span> notice <span class="string">&quot;deconfigured&quot;</span></span><br><span class="line">	;;</span><br><span class="line"></span><br><span class="line">    leasefail | nak)</span><br><span class="line">	<span class="keyword">if</span> [ -f /dev/shm/DEBUG ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;nak <span class="variable">$interface</span>&quot;</span> &gt; /dev/kmsg</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	save_config <span class="variable">$interface</span>  <span class="string">&quot;\ &quot;</span> <span class="string">&quot;\ &quot;</span> <span class="string">&quot;\ &quot;</span> <span class="string">&quot;noip&quot;</span></span><br><span class="line">	<span class="built_in">log</span> err <span class="string">&quot;configuration failed: <span class="variable">$1</span>: <span class="variable">$message</span>&quot;</span></span><br><span class="line">	;;</span><br><span class="line"></span><br><span class="line">    *)</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: Unknown udhcpc command: <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line">	;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">set_iproute</span><br><span class="line"></span><br><span class="line">[ -f /etc/udhcpc.user ] &amp;&amp; . /etc/udhcpc.user <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在每次网线插拔是会调用该脚本，网卡获取ip以及基于优先级的路由设置。并且会判断是否出现ip冲突的情况。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/06/%E8%AE%BE%E7%BD%AEwifi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/06/%E8%AE%BE%E7%BD%AEwifi/" class="post-title-link" itemprop="url">set-wifi</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-06 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-06T19:30:00+08:00">2022-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:59:04" itemprop="dateModified" datetime="2022-04-27T15:59:04+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-wifi/" itemprop="url" rel="index"><span itemprop="name">linux wifi</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="创建WIFI"><a href="#创建WIFI" class="headerlink" title="创建WIFI"></a>创建WIFI</h5><p>使用NetworkManager的工具nmcli创建<br>2.4G 和  5G  WIFI的区别只是创建时的参数不同</p>
<p>IP范围   10.42.0.1&#x2F;26</p>
<ol>
<li>创建后NetworkManager服务将自动添加  10.42.0.1&#x2F;24的路由</li>
<li>NetworkManager将自动启动dnsmasq 作为WIFi热点的 DHCP Server，分配IP为10.42.0.1&#x2F;26</li>
<li>并自动添加了一条掩码是26的SNAT</li>
<li>本记录在setroute.sh中 将掩码修改为24 支持LAN+WIFI</li>
</ol>
<h6 id="与LAN的IP分段"><a href="#与LAN的IP分段" class="headerlink" title="与LAN的IP分段"></a>与LAN的IP分段</h6><p>WIFI使用 10.42.0.1  – 10.42.0.62<br>LAN使用  10.42.0.129 – 10.42.0.190</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">. <span class="regexp">/home/</span>butel<span class="regexp">/4GFusion/</span>sh/fuslog.sh</span><br><span class="line">name=<span class="variable">$1</span></span><br><span class="line">band=<span class="variable">$2</span></span><br><span class="line">password=<span class="variable">$3</span></span><br><span class="line">cfgname=<span class="string">&quot;default-wlan0&quot;</span></span><br><span class="line">is_ubuntu18=` cat <span class="regexp">/etc/i</span>ssue | grep <span class="number">18</span>`</span><br><span class="line"></span><br><span class="line">json_file=<span class="string">&quot;/home/butel/config/interface.json&quot;</span></span><br><span class="line">wireless_json_file=<span class="string">&quot;/home/butel/config/wireless.json&quot;</span></span><br><span class="line">BR_IP=`cat <span class="variable">$&#123;json_file&#125;</span> |jq -r .dhcpsrv.listen_address`</span><br><span class="line">WIFI_IP=`cat <span class="variable">$&#123;wireless_json_file&#125;</span> |jq -r <span class="string">&quot;.ipaddr&quot;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$1&quot;</span> != <span class="string">&quot;closedown&quot;</span> ];</span><br><span class="line">then</span><br><span class="line">    echo -e <span class="string">&quot;----------------------\n&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">    echo $(date +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>) &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">    echo <span class="string">&quot;openwifiAp2.sh start&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">    echo <span class="string">&quot;ubuntu18: &quot;</span> <span class="variable">$is_ubuntu18</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">nmcli r wifi off</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;$is_ubuntu18&quot;</span> ]; then</span><br><span class="line">    nmcli con show | grep <span class="string">&quot;wifi&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs nmcli con <span class="keyword">delete</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    nmcli con show | grep <span class="string">&quot;wireless&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs nmcli con <span class="keyword">delete</span></span><br><span class="line">fi</span><br><span class="line">echo <span class="string">&quot;delete All wireless&quot;</span> </span><br><span class="line">nmcli r wifi on</span><br><span class="line">sleep <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$1&quot;</span> == <span class="string">&quot;closedown&quot;</span> ];</span><br><span class="line">then</span><br><span class="line">    sed -i <span class="string">&#x27;4c off&#x27;</span> <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    iptables -t nat -A WIFIOFF -i br0 -d <span class="variable">$WIFI_IP</span> -j DNAT --to <span class="variable">$BR_IP</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">fi</span><br><span class="line">    echo <span class="string">&quot;delete All wireless&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$2&quot;</span> == <span class="string">&quot;a&quot;</span> ];</span><br><span class="line">then</span><br><span class="line">    nmcli con add type wifi ifname wlan0 con-name <span class="variable">$cfgname</span> autoconnect yes ssid <span class="variable">$name</span><span class="string">&quot;-5G&quot;</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless.mode ap <span class="number">802</span>-<span class="number">11</span>-wireless.band a <span class="number">802</span>-<span class="number">11</span>-wireless.powersave <span class="number">2</span> ipv4.method shared </span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.key-mgmt wpa-psk </span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.proto rsn </span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.pairwise ccmp </span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.psk <span class="string">&quot;$password&quot;</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> ipv4.addresses <span class="variable">$WIFI_IP</span>/<span class="number">26</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> +ipv4.routes <span class="string">&quot;$WIFI_IP/26 table=122&quot;</span></span><br><span class="line">    echo <span class="string">&quot;$name&quot;</span> &gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo <span class="string">&quot;$band&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo <span class="string">&quot;$password&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo  <span class="string">&quot;on&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    nmcli con up <span class="variable">$cfgname</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    nmcli con add type wifi ifname wlan0 con-name <span class="variable">$cfgname</span> autoconnect yes ssid <span class="variable">$name</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless.mode ap <span class="number">802</span>-<span class="number">11</span>-wireless.band bg  <span class="number">802</span>-<span class="number">11</span>-wireless.powersave <span class="number">2</span> ipv4.method shared </span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.key-mgmt wpa-psk</span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.proto rsn</span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> <span class="number">802</span>-<span class="number">11</span>-wireless-security.pairwise ccmp</span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> wifi-sec.psk <span class="string">&quot;$password&quot;</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> ipv4.addresses <span class="variable">$WIFI_IP</span>/<span class="number">26</span></span><br><span class="line">    nmcli con modify <span class="variable">$cfgname</span> +ipv4.routes <span class="string">&quot;$WIFI_IP/26 table=122&quot;</span></span><br><span class="line">    nmcli con up <span class="variable">$cfgname</span></span><br><span class="line">    echo <span class="string">&quot;$name&quot;</span> &gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo <span class="string">&quot;$band&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo <span class="string">&quot;$password&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">    echo  <span class="string">&quot;on&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel<span class="regexp">/config/</span>WIFISET</span><br><span class="line">fi</span><br><span class="line">iptables -t nat -F WIFIOFF </span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;openwifiap2 success&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">echo <span class="string">&quot;----------------------&quot;</span> &gt;&gt; <span class="regexp">/home/</span>butel/update.log</span><br><span class="line">flog debug <span class="string">&quot;openwifi  success&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/06/%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E5%AD%90%E8%B7%AF%E7%94%B1%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/06/%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E5%AD%90%E8%B7%AF%E7%94%B1%E8%A1%A8/" class="post-title-link" itemprop="url">ip route/rule</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-06 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-06T19:30:00+08:00">2022-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:59:13" itemprop="dateModified" datetime="2022-04-27T15:59:13+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux-route/" itemprop="url" rel="index"><span itemprop="name">linux route</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="问题-linux出口路由只有一个，不能满足多线同时上网"><a href="#问题-linux出口路由只有一个，不能满足多线同时上网" class="headerlink" title="问题:linux出口路由只有一个，不能满足多线同时上网"></a>问题:linux出口路由只有一个，不能满足多线同时上网</h4><h5 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h5><ol>
<li>添加路由规则<ol>
<li>设定源为每个线路ip的数据包走某个特定路由表<br> ip rule add form $ip table $table_name</li>
<li>设置子路由表内容<br> 在子路由表中添加对应线路的默认出口路由<br> ip route add default dev $ifname table $table_name</li>
<li>通过脚本自动设置和更新路由规则</li>
</ol>
</li>
</ol>
<p>编程上：通过绑定网卡ip的方式向公网发送数据</p>
<p>遇到问题: 多网线下，优先级高的网线无法上网时，有线无法进行dns解析服务。<br>原因: 默认使用优先级高的默认路由进行dns解析服务<br>解决方式: 绑定br0 ip后,会从122表中的默认路由去请求dns服务。<br>对于lan口使用桥接方式后,绑定br0网卡ip 进行dnsmasqlocal服务</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ip</span> route add <span class="number">10.42.0.128</span>/<span class="number">26</span> dev <span class="variable">$&#123;interface&#125;</span> table <span class="number">122</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.1</span><span class="number">.1</span> zlhfroot<span class="variable">@zlhf</span>:<span class="operator">/</span>home<span class="operator">/</span>zlhf# ip rule <span class="keyword">show</span></span><br><span class="line"><span class="number">0</span>:      <span class="keyword">from</span> <span class="keyword">all</span> lookup <span class="keyword">local</span></span><br><span class="line"><span class="number">32764</span>:  <span class="keyword">from</span> <span class="number">10.160</span><span class="number">.94</span><span class="number">.112</span> lookup reth0</span><br><span class="line"><span class="number">32765</span>:  <span class="keyword">from</span> <span class="number">10.42</span><span class="number">.0</span><span class="number">.128</span><span class="operator">/</span><span class="number">26</span> lookup <span class="number">122</span></span><br><span class="line"><span class="number">32766</span>:  <span class="keyword">from</span> <span class="keyword">all</span> lookup main</span><br><span class="line"><span class="number">32767</span>:  <span class="keyword">from</span> <span class="keyword">all</span> lookup <span class="keyword">default</span></span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span>@zlhf:/home/zlhf# ip route show table <span class="number">122</span></span><br><span class="line"><span class="attribute">default</span> dev tun0 scope link</span><br><span class="line"><span class="attribute">default</span> via <span class="number">10.160.94.1</span> dev eth0 metric <span class="number">100</span></span><br><span class="line"><span class="attribute">10</span>.<span class="number">42</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">26</span> dev wlan0 proto static scope link metric <span class="number">600</span></span><br><span class="line"><span class="attribute">10</span>.<span class="number">42</span>.<span class="number">0</span>.<span class="number">128</span>/<span class="number">26</span> dev br0 scope link linkdown</span><br><span class="line"><span class="attribute">10</span>.<span class="number">160</span>.<span class="number">94</span>.<span class="number">0</span>/<span class="number">24</span> dev eth0 scope link</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://cachefish.github.io/2022/04/02/%E5%AE%9A%E6%97%B6%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2229.jfif">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="来世做春风，浪漫且自由">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cachecatのBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/02/%E5%AE%9A%E6%97%B6%E5%99%A8/" class="post-title-link" itemprop="url">定时器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-02 19:30:00" itemprop="dateCreated datePublished" datetime="2022-04-02T19:30:00+08:00">2022-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-27 15:58:43" itemprop="dateModified" datetime="2022-04-27T15:58:43+08:00">2022-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c-base/" itemprop="url" rel="index"><span itemprop="name">c++ base</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h4><p>非活跃，是指客户端（这里是浏览器）与服务器端建立连接后，长时间不交换数据，一直占用服务器端的文件描述符，导致连接资源的浪费。</p>
<p>定时事件，是指固定一段时间之后触发某段代码，由该段代码处理一个事件，如从内核事件表删除事件，并关闭文件描述符，释放连接资源。</p>
<p>定时器，是指利用结构体或其他形式，将多种定时事件进行封装起来。具体的，这里只涉及一种定时事件，即定期检测非活跃连接，这里将该定时事件与连接资源封装为一个结构体定时器。</p>
<p>定时器容器，是指使用某种容器类数据结构，将上述多个定时器组合起来，便于对定时事件统一管理。具体的，项目中使用升序链表将所有定时器串联组织起来。</p>
<h4 id="整体概述"><a href="#整体概述" class="headerlink" title="整体概述"></a>整体概述</h4><p>服务器主循环为每一个连接创建一个定时器，并对每个连接进行定时。另外，利用升序时间链表容器将所有定时器串联起来，若主循环接收到定时通知，则在链表中依次执行定时任务。</p>
<p>Linux下提供了三种定时的方法:</p>
<ul>
<li>socket选项SO_RECVTIMEO和SO_SNDTIMEO</li>
<li>SIGALRM信号</li>
<li>I&#x2F;O复用系统调用的超时参数</li>
</ul>
<p>三种方法没有一劳永逸的应用场景，也没有绝对的优劣。由于项目中使用的是SIGALRM信号，这里仅对其进行介绍，另外两种方法可以查阅游双的Linux高性能服务器编程 第11章 定时器。</p>
<p>具体的，利用alarm函数周期性地触发SIGALRM信号，信号处理函数利用管道通知主循环，主循环接收到该信号后对升序链表上所有定时器进行处理，若该段时间内没有交换数据，则将该连接关闭，释放所占用的资源。</p>
<p>从上面的简要描述中，可以看出定时器处理非活动连接模块，主要分为两部分，&#x3D;&#x3D;其一为定时方法与信号通知流程，其二为定时器及其容器设计与定时任务的处理。&#x3D;&#x3D;</p>
<hr>
<p>基础API，描述sigaction结构体、sigaction函数、sigfillset函数、SIGALRM信号、SIGTERM信号、alarm函数、socketpair函数、send函数。</p>
<p>信号通知流程，介绍统一事件源和信号处理机制。</p>
<h6 id="sigaction结构体"><a href="#sigaction结构体" class="headerlink" title="sigaction结构体"></a>sigaction结构体</h6><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> sigaction &#123;</span><br><span class="line">   <span class="keyword">void</span> (*sa_handler)(<span class="built_in">int</span>);   </span><br><span class="line">   <span class="keyword">void</span> (*sa_sigaction)(<span class="built_in">int</span>, siginfo_t *, <span class="keyword">void</span> *);</span><br><span class="line">   sigset_t sa_mask;</span><br><span class="line">    <span class="built_in">int</span> sa_flags;</span><br><span class="line">    <span class="keyword">void</span> (*sa_restorer)(<span class="keyword">void</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>sa_handler是一个函数指针，指向信号处理函数</li>
<li>sa_sigaction同样是信号处理函数，有三个参数，可以获得关于信号更详细的信息</li>
<li>sa_mask用来指定在信号处理函数执行期间需要被屏蔽的信号</li>
<li>sa_flags用于指定信号处理的行为<ul>
<li>SA_RESTART，使被信号打断的系统调用自动重新发起</li>
<li>SA_NOCLDSTOP，使父进程在它的子进程暂停或继续运行时不会收到 SIGCHLD 信号</li>
<li>SA_NOCLDWAIT，使父进程在它的子进程退出时不会收到 SIGCHLD 信号，这时子进程如果退出也不会成为僵尸进程</li>
<li>SA_NODEFER，使对信号的屏蔽无效，即在信号处理函数执行期间仍能发出这个信号</li>
<li>SA_RESETHAND，信号处理之后重新设置为默认的处理方式</li>
<li>SA_SIGINFO，使用 sa_sigaction 成员而不是 sa_handler 作为信号处理函数</li>
</ul>
</li>
<li>sa_restorer一般不使用</li>
</ul>
<h6 id="sigaction函数"><a href="#sigaction函数" class="headerlink" title="sigaction函数"></a>sigaction函数</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *act, <span class="keyword">struct</span> sigaction *oldact)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>signum表示操作的信号。</li>
<li>act表示对信号设置新的处理方式。</li>
<li>oldact表示信号原来的处理方式。</li>
<li>返回值，0 表示成功，-1 表示有错误发生。</li>
</ul>
<h6 id="sigfillset函数"><a href="#sigfillset函数" class="headerlink" title="sigfillset函数"></a>sigfillset函数</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *set)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>用来将参数set信号集初始化，然后把所有的信号加入到此信号集里。</li>
</ul>
<h5 id="SIGALRM、SIGTERM信号"><a href="#SIGALRM、SIGTERM信号" class="headerlink" title="SIGALRM、SIGTERM信号"></a>SIGALRM、SIGTERM信号</h5><p>1#define SIGALRM  14     &#x2F;&#x2F;由alarm系统调用产生timer时钟信号<br>2#define SIGTERM  15     &#x2F;&#x2F;终端发送的终止信号</p>
<h6 id="alarm函数-96"><a href="#alarm函数-96" class="headerlink" title="alarm函数&#96;"></a>alarm函数&#96;</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>;</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span></span>;</span><br></pre></td></tr></table></figure>
<p>设置信号传送闹钟，即用来设置信号SIGALRM在经过参数seconds秒数后发送给目前的进程。如果未设置信号SIGALRM的处理函数，那么alarm()默认处理终止进程.</p>
<h5 id="socketpair函数"><a href="#socketpair函数" class="headerlink" title="socketpair函数"></a>socketpair函数</h5><p>在linux下，使用socketpair函数能够创建一对套接字进行通信</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">socketpair</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol, <span class="type">int</span> sv[<span class="number">2</span>])</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>domain表示协议族，PF_UNIX或者AF_UNIX</li>
<li>type表示协议，可以是SOCK_STREAM或者SOCK_DGRAM，SOCK_STREAM基于TCP，SOCK_DGRAM基于UDP</li>
<li>protocol表示类型，只能为0</li>
<li>sv[2]表示套节字柄对，该两个句柄作用相同，均能进行读写双向操作</li>
<li>返回结果， 0为创建成功，-1为创建失败</li>
</ul>
<h5 id="send函数"><a href="#send函数" class="headerlink" title="send函数"></a>send函数</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">send</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p>当套接字发送缓冲区变满时，send通常会阻塞，除非套接字设置为非阻塞模式，当缓冲区变满时，返回EAGAIN或者EWOULDBLOCK错误，此时可以调用select函数来监视何时可以发送数据。</p>
<h5 id="信号通知流程"><a href="#信号通知流程" class="headerlink" title="信号通知流程"></a>信号通知流程</h5><p>Linux下的信号采用的异步处理机制，信号处理函数和当前进程是两条不同的执行路线。具体的，当进程收到信号时，操作系统会中断进程当前的正常流程，转而进入信号处理函数执行操作，完成后再返回中断的地方继续执行。</p>
<p>为避免信号竞态现象发生，信号处理期间系统不会再次触发它。所以，为确保该信号不被屏蔽太久，信号处理函数需要尽可能快地执行完毕。</p>
<p>一般的信号处理函数需要处理该信号对应的逻辑，当该逻辑比较复杂时，信号处理函数执行时间过长，会导致信号屏蔽太久。</p>
<p>这里的解决方案是，信号处理函数仅仅发送信号通知程序主循环，将信号对应的处理逻辑放在程序主循环中，由主循环执行信号对应的逻辑代码。</p>
<h5 id="统一事件源"><a href="#统一事件源" class="headerlink" title="统一事件源"></a>统一事件源</h5><p>统一事件源，是指将信号事件与其他事件一样被处理。</p>
<p>具体的，信号处理函数使用管道将信号传递给主循环，信号处理函数往管道的写端写入信号值，主循环则从管道的读端读出信号值，使用I&#x2F;O复用系统调用来监听管道读端的可读事件，这样信号事件与其他文件描述符都可以通过epoll来监测，从而实现统一处理。</p>
<p>信号处理机制<br>每个进程之中，都有存着一个表，里面存着每种信号所代表的含义，内核通过设置表项中每一个位来标识对应的信号类型。</p>
<p>信号的接收</p>
<p>接收信号的任务是由内核代理的，当内核接收到信号后，会将其放到对应进程的信号队列中，同时向进程发送一个中断，使其陷入内核态。注意，此时信号还只是在队列中，对进程来说暂时是不知道有信号到来的。</p>
<p>信号的检测</p>
<p>进程从内核态返回到用户态前进行信号检测</p>
<p>进程在内核态中，从睡眠状态被唤醒的时候进行信号检测</p>
<p>进程陷入内核态后，有两种场景会对信号进行检测：</p>
<p>当发现有新信号时，便会进入下一步，信号的处理。</p>
<p>信号的处理</p>
<ul>
<li>( 内核 )信号处理函数是运行在用户态的，调用处理函数前，内核会将当前内核栈的内容备份拷贝到用户栈上，并且修改指令寄存器（eip）将其指向信号处理函数。</li>
<li>( 用户 )接下来进程返回到用户态中，执行相应的信号处理函数。</li>
<li>( 内核 )信号处理函数执行完成后，还需要返回内核态，检查是否还有其它信号未处理。</li>
<li>( 用户 )如果所有信号都处理完成，就会将内核栈恢复（从用户栈的备份拷贝回来），同时恢复指令寄存器（eip）将其指向中断前的运行位置，最后回到用户态继续执行进程。</li>
<li>至此，一个完整的信号处理流程便结束了，如果同时有多个信号到达，上面的处理流程会在第2步和第3步骤间重复进行。</li>
</ul>
<p>信号处理函数<br>自定义信号处理函数，创建sigaction结构体变量，设置信号函数。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//信号处理函数</span></span><br><span class="line"> void <span class="keyword">sig</span><span class="constructor">_handler(<span class="params">int</span> <span class="params">sig</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="comment">//为保证函数的可重入性，保留原来的errno</span></span><br><span class="line">     <span class="comment">//可重入性表示中断后再次进入该函数，环境变量与之前相同，不会丢失数据</span></span><br><span class="line">     <span class="built_in">int</span> save_errno = errno;</span><br><span class="line">     <span class="built_in">int</span> msg = <span class="keyword">sig</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//将信号值从管道写端写入，传输字符类型，而非整型</span></span><br><span class="line">    send(pipefd<span class="literal">[<span class="number">1</span>]</span>, (<span class="built_in">char</span> *)&amp;msg, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将原来的errno赋值为当前的errno</span></span><br><span class="line">    errno = save_errno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>信号处理函数中仅仅通过管道发送信号值，不处理信号对应的逻辑，缩短异步执行时间，减少对主程序的影响。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//设置信号函数</span></span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">addsig</span><span class="params">(<span class="type">int</span> sig, <span class="type">void</span>(handler)(<span class="type">int</span>), <span class="type">bool</span> restart = <span class="literal">true</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="comment">//创建sigaction结构体变量</span></span><br><span class="line">     <span class="keyword">struct</span> <span class="title class_">sigaction</span> sa;</span><br><span class="line">     <span class="built_in">memset</span>(&amp;sa, <span class="string">&#x27;\0&#x27;</span>, <span class="built_in">sizeof</span>(sa));</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//信号处理函数中仅仅发送信号值，不做对应逻辑处理</span></span><br><span class="line">     sa.sa_handler = handler;</span><br><span class="line">    <span class="keyword">if</span> (restart)</span><br><span class="line">        sa.sa_flags |= SA_RESTART;</span><br><span class="line">    <span class="comment">//将所有信号添加到信号集中</span></span><br><span class="line">    <span class="built_in">sigfillset</span>(&amp;sa.sa_mask);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行sigaction函数</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">sigaction</span>(sig, &amp;sa, <span class="literal">NULL</span>) != <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="信号通知逻辑"><a href="#信号通知逻辑" class="headerlink" title="信号通知逻辑"></a>信号通知逻辑</h4><ul>
<li>创建管道，其中管道写端写入信号值，管道读端通过I&#x2F;O复用系统监测读事件</li>
<li>设置信号处理函数SIGALRM（时间到了触发）和SIGTERM（kill会触发，Ctrl+C）<ul>
<li>通过struct sigaction结构体和sigaction函数注册信号捕捉函数</li>
<li>在结构体的handler参数设置信号处理函数，具体的，从管道写端写入信号的名字</li>
</ul>
</li>
<li>利用I&#x2F;O复用系统监听管道读端文件描述符的可读事件</li>
<li>信息值传递给主循环，主循环再根据接收到的信号值执行目标信号对应的逻辑代码</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建管道套接字</span></span><br><span class="line"> ret = socketpair(PF_UNIX, SOCK_STREAM, <span class="number">0</span>, pipefd);</span><br><span class="line"> assert(ret != <span class="number">-1</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//设置管道写端为非阻塞，为什么写端要非阻塞？</span></span><br><span class="line"> setnonblocking(pipefd[<span class="number">1</span>]);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//设置管道读端为ET非阻塞</span></span><br><span class="line"> addfd(epollfd, pipefd[<span class="number">0</span>], <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//传递给主循环的信号值，这里只关注SIGALRM和SIGTERM</span></span><br><span class="line">addsig(SIGALRM, sig_handler, <span class="literal">false</span>);</span><br><span class="line">addsig(SIGTERM, sig_handler, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环条件</span></span><br><span class="line"><span class="built_in">bool</span> stop_server = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//超时标志</span></span><br><span class="line"><span class="built_in">bool</span> timeout = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每隔TIMESLOT时间触发SIGALRM信号</span></span><br><span class="line">alarm(TIMESLOT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!stop_server)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//监测发生事件的文件描述符</span></span><br><span class="line">    <span class="built_in">int</span> number = epoll_wait(epollfd, events, MAX_EVENT_NUMBER, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (number &lt; <span class="number">0</span> &amp;&amp; errno != EINTR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//轮询文件描述符</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; number; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> sockfd = events[i].data.fd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//管道读端对应文件描述符发生读事件</span></span><br><span class="line">        <span class="keyword">if</span> ((sockfd == pipefd[<span class="number">0</span>]) &amp;&amp; (events[i].events &amp; EPOLLIN))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> sig;</span><br><span class="line">            <span class="built_in">char</span> signals[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从管道读端读出信号值，成功返回字节数，失败返回-1</span></span><br><span class="line">            <span class="comment">//正常情况下，这里的ret返回值总是1，只有14和15两个ASCII码对应的字符</span></span><br><span class="line">            ret = recv(pipefd[<span class="number">0</span>], signals, <span class="keyword">sizeof</span>(signals), <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// handle the error</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//处理信号值对应的逻辑</span></span><br><span class="line">               <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ret; ++i)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//这里面明明是字符</span></span><br><span class="line">                    <span class="keyword">switch</span> (signals[i])</span><br><span class="line">                    &#123;</span><br><span class="line">                    <span class="comment">//这里是整型</span></span><br><span class="line">                    <span class="keyword">case</span> SIGALRM:</span><br><span class="line">                    &#123;</span><br><span class="line">                        timeout = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> SIGTERM:</span><br><span class="line">                    &#123;</span><br><span class="line">                        stop_server = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="为什么管道写端要非阻塞？"><a href="#为什么管道写端要非阻塞？" class="headerlink" title="为什么管道写端要非阻塞？"></a>为什么管道写端要非阻塞？</h5><p>send是将信息发送给套接字缓冲区，如果缓冲区满了，则会阻塞，这时候会进一步增加信号处理函数的执行时间，为此，将其修改为非阻塞。</p>
<h5 id="没有对非阻塞返回值处理，如果阻塞是不是意味着这一次定时事件失效了？"><a href="#没有对非阻塞返回值处理，如果阻塞是不是意味着这一次定时事件失效了？" class="headerlink" title="没有对非阻塞返回值处理，如果阻塞是不是意味着这一次定时事件失效了？"></a>没有对非阻塞返回值处理，如果阻塞是不是意味着这一次定时事件失效了？</h5><p>是的，但定时事件是非必须立即处理的事件，可以允许这样的情况发生。</p>
<h5 id="管道传递的是什么类型？switch-case的变量冲突？"><a href="#管道传递的是什么类型？switch-case的变量冲突？" class="headerlink" title="管道传递的是什么类型？switch-case的变量冲突？"></a>管道传递的是什么类型？switch-case的变量冲突？</h5><p>信号本身是整型数值，管道中传递的是ASCII码表中整型数值对应的字符。</p>
<p>switch的变量一般为字符或整型，当switch的变量为字符时，case中可以是字符，也可以是字符对应的ASCII码。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt=""
      src="/images/2229.jfif">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description">来世做春风，浪漫且自由</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cachefish" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cachefish" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/cachefish@163g.com" title="E-Mail → cachefish@163g.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cachecat</span>
</div>
<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"left","width":240,"height":360},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false,"tagMode":false});</script></body>
</html>
